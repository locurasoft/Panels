require("ctrlrTestUtils")
require("Logger")
require("MockPanel")
require("controller/EmuProteus2Controller")
require("controller/EmuProteus2ControllerAutogen")
require("controller/onPanelBeforeLoad")
require 'lunity'
require 'lemock'
module( 'EmuProteus2ControllerTest', lunity )

local log = Logger("EmuProteus2ControllerTest")

local modulatorMap = {
  ["auxEnvHold"] = 0,
  ["modulator-8"] = 0,
  ["auxEnvSustain"] = 99,
  ["Voice177"] = 1,
  ["VoiceName9"] = 108,
  ["VoiceName10"] = 111,
  ["VoiceName3"] = 108,
  ["Name1"] = 0,
  ["secLowKey"] = 0,
  ["Envelope"] = 0,
  ["auxEnvRelease"] = 20,
  ["Voice37"] = 0,
  ["priVolume"] = 120,
  ["secReverse"] = 0,
  ["priTuningFine"] = 0,
  ["curve"] = 5,
  ["pressure"] = 16,
  ["Voice173"] = 1,
  ["modulator-5"] = 0,
  ["modulator-23"] = 0,
  ["auxEnvAttack"] = 0,
  ["Voice171"] = 1,
  ["Voice169"] = 1,
  ["Voice35"] = -1,
  ["xFadeSwitchPoint"] = 64,
  ["modulator-14"] = 0,
  ["modulator-9"] = 0,
  ["modulator-29"] = 0,
  ["patchSelect"] = 0,
  ["AuxEnvelope"] = 0,
  ["secTuningCoarse"] = 0,
  ["Voice243"] = 32,
  ["modulator-1"] = 0,
  ["priEnvAttack"] = 5,
  ["xFadeMode"] = 0,
  ["lfo1Amount"] = 0,
  ["modulator-19"] = 0,
  ["Voice223"] = 8,
  ["modulator-28"] = 0,
  ["Voice237"] = 1,
  ["auxEnvAmount"] = 0,
  ["Voice231"] = 1,
  ["modulator-2"] = 0,
  ["kdbCenter"] = 55,
  ["kbdTuning"] = 0,
  ["secEnvSustain"] = 99,
  ["Voice179"] = 1,
  ["lfo1Delay"] = 0,
  ["secTuningFine"] = 0,
  ["secSolo"] = 0,
  ["secEnvDelay"] = 0,
  ["modulator-16"] = 0,
  ["xFadeDirection"] = 0,
  ["secEnvHold"] = 0,
  ["lfo1Shape"] = 1,
  ["Voice191"] = 2,
  ["Save"] = 0,
  ["Voice199"] = -50,
  ["modulator-13"] = 0,
  ["secVolume"] = 120,
  ["Voice239"] = 0,
  ["priTuningCoarse"] = 0,
  ["Voice33"] = -1,
  ["Voice211"] = 5,
  ["lfo2Delay"] = 0,
  ["modulator-11"] = 0,
  ["modulator-15"] = 0,
  ["priEnvSustain"] = 56,
  ["Voice221"] = 1,
  ["Voice209"] = 1,
  ["Load"] = 0,
  ["Voice241"] = 0,
  ["Voice31"] = -1,
  ["priPan"] = 0,
  ["VoiceName1"] = 83,
  ["modulator-10"] = 0,
  ["submix"] = 0,
  ["secPan"] = 0,
  ["VoiceName11"] = 32,
  ["secEnvAttack"] = 0,
  ["Voice217"] = 1,
  ["pitchBendRange"] = 13,
  ["modulator-3"] = 0,
  ["lfo1Variation"] = 0,
  ["Envelope-1"] = 0,
  ["Voice41"] = 55,
  ["Voice235"] = 0,
  ["priEnvRelease"] = 25,
  ["Voice_globalPatchControls"] = 0,
  ["Instrument1"] = 0,
  ["Voice213"] = 6,
  ["Crossfade"] = 0,
  ["PatchIndex"] = 0,
  ["VoiceName2"] = 111,
  ["Voice229"] = 5,
  ["VoiceName4"] = 111,
  ["VoiceName5"] = 32,
  ["auxEnvDelay"] = 0,
  ["VoiceName6"] = 67,
  ["Voice245"] = 64,
  ["Voice181"] = 4,
  ["priLowKey"] = 36,
  ["secHighKey"] = 127,
  ["VoiceName7"] = 101,
  ["VoiceName8"] = 108,
  ["VoiceName12"] = 32,
  ["Voice249"] = 64,
  ["lfo2Frequency"] = 60,
  ["priEnvHold"] = 12,
  ["Voice247"] = 64,
  ["secEnvRelease"] = 15,
  ["modulator-6"] = 0,
  ["modulator-26"] = 0,
  ["SecInstrument"] = 1,
  ["Voice189"] = 13,
  ["priEnvelope"] = 1,
  ["Voice225"] = 5,
  ["priEnvDecay"] = 80,
  ["Voice227"] = 5,
  ["Voice233"] = 0,
  ["Voice219"] = 9,
  ["priChorus"] = 0,
  ["Voice215"] = 7,
  ["modulator-25"] = 0,
  ["Voice195"] = 40,
  ["modulator-18"] = 0,
  ["Voice207"] = 1,
  ["PriInstrument"] = 16,
  ["Voice205"] = 0,
  ["Voice193"] = 40,
  ["Links"] = 0,
  ["Voice197"] = -4,
  ["xFadeAmount"] = 128,
  ["modulator-4"] = 0,
  ["secEnvelope"] = 1,
  ["priSmplStartOffs"] = 0,
  ["auxEnvDecay"] = 0,
  ["priHighKey"] = 72,
  ["lfo2Amount"] = 0,
  ["Voice201"] = -8,
  ["Voice43"] = 0,
  ["Voice203"] = 1,
  ["modulator-7"] = 0,
  ["Voice175"] = 0,
  ["secSmplStartOffs"] = 0,
  ["Voice47"] = 127,
  ["Voice45"] = 127,
  ["Voice185"] = 8,
  ["Voice187"] = 4,
  ["modulator-21"] = 0,
  ["lfo1Frequency"] = 60,
  ["secEnvDecay"] = 0,
  ["modulator-20"] = 0,
  ["LFO1"] = 0,
  ["modulator-30"] = 0,
  ["Voice183"] = 31,
  ["xFadeBalance"] = 0,
  ["modulator-27"] = 0,
  ["priReverse"] = 0,
  ["modulator-24"] = 0,
  ["Voice51"] = 127,
  ["secChorus"] = 0,
  ["modulator-12"] = 0,
  ["modulator-17"] = 0,
  ["Voice39"] = 48,
  ["lfo2Variation"] = 0,
  ["priSolo"] = 0,
  ["modulator-22"] = 0,
  ["priEnvDelay"] = 0,
  ["lfo2Shape"] = 1,
  ["Voice49"] = 127
}

local trps8vaMap = {
  ["auxEnvHold"] = 0,
  ["modulator-8"] = 0,
  ["auxEnvSustain"] = 40,
  ["Voice177"] = 0,
  ["VoiceName9"] = 115,
  ["VoiceName10"] = 46,
  ["VoiceName3"] = 69,
  ["Name1"] = 0,
  ["secLowKey"] = 0,
  ["Envelope"] = 0,
  ["auxEnvRelease"] = 50,
  ["Voice37"] = 0,
  ["priVolume"] = 102,
  ["secReverse"] = 0,
  ["priTuningFine"] = 1,
  ["curve"] = 5,
  ["pressure"] = 46,
  ["Voice173"] = 1,
  ["modulator-5"] = 0,
  ["modulator-23"] = 0,
  ["auxEnvAttack"] = 0,
  ["Voice171"] = 1,
  ["Voice169"] = 1,
  ["Voice35"] = -1,
  ["xFadeSwitchPoint"] = 64,
  ["modulator-14"] = 0,
  ["modulator-9"] = 0,
  ["modulator-29"] = 0,
  ["AuxEnvelope"] = 0,
  ["secTuningCoarse"] = 0,
  ["Voice243"] = 24,
  ["modulator-1"] = 0,
  ["priEnvAttack"] = 0,
  ["xFadeMode"] = 0,
  ["lfo1Amount"] = 0,
  ["modulator-19"] = 0,
  ["Voice223"] = 17,
  ["modulator-28"] = 0,
  ["Voice237"] = 1,
  ["auxEnvAmount"] = 0,
  ["Voice231"] = 0,
  ["modulator-2"] = 0,
  ["kdbCenter"] = 60,
  ["kbdTuning"] = 0,
  ["secEnvSustain"] = 50,
  ["Voice179"] = 0,
  ["lfo1Delay"] = 0,
  ["secTuningFine"] = -1,
  ["secSolo"] = 0,
  ["secEnvDelay"] = 2,
  ["modulator-16"] = 0,
  ["xFadeDirection"] = 0,
  ["secEnvHold"] = 0,
  ["lfo1Shape"] = 1,
  ["Voice191"] = 0,
  ["Save"] = 0,
  ["Voice199"] = 64,
  ["modulator-13"] = 0,
  ["secVolume"] = 110,
  ["Voice239"] = 0,
  ["priTuningCoarse"] = 0,
  ["Voice33"] = -1,
  ["Voice211"] = 2,
  ["lfo2Delay"] = 0,
  ["modulator-11"] = 0,
  ["modulator-15"] = 0,
  ["priEnvSustain"] = 50,
  ["Voice221"] = 1,
  ["Voice209"] = 7,
  ["Load"] = 0,
  ["Voice241"] = 0,
  ["Voice31"] = -1,
  ["priPan"] = -7,
  ["VoiceName1"] = 50,
  ["modulator-10"] = 0,
  ["submix"] = 0,
  ["secPan"] = 7,
  ["VoiceName11"] = 32,
  ["secEnvAttack"] = 0,
  ["Voice217"] = 5,
  ["pitchBendRange"] = 13,
  ["modulator-3"] = 0,
  ["lfo1Variation"] = 0,
  ["Envelope-1"] = 0,
  ["Voice41"] = 0,
  ["Voice235"] = 0,
  ["priEnvRelease"] = 30,
  ["Voice_globalPatchControls"] = 0,
  ["Instrument1"] = 0,
  ["Voice213"] = 3,
  ["Crossfade"] = 0,
  ["PatchIndex"] = 64,
  ["VoiceName2"] = 32,
  ["VoiceName4"] = 110,
  ["Voice229"] = 0,
  ["VoiceName5"] = 103,
  ["VoiceName6"] = 46,
  ["auxEnvDelay"] = 0,
  ["VoiceName7"] = 72,
  ["Voice245"] = 127,
  ["Voice181"] = 5,
  ["priLowKey"] = 0,
  ["secHighKey"] = 127,
  ["VoiceName8"] = 110,
  ["VoiceName12"] = 32,
  ["Voice249"] = 127,
  ["Voice247"] = 127,
  ["lfo2Frequency"] = 60,
  ["priEnvHold"] = 0,
  ["Voice225"] = 1,
  ["secEnvRelease"] = 30,
  ["modulator-6"] = 0,
  ["modulator-26"] = 0,
  ["SecInstrument"] = 37,
  ["Voice189"] = 0,
  ["priEnvelope"] = 0,
  ["Voice227"] = 0,
  ["priEnvDecay"] = 10,
  ["Voice233"] = 0,
  ["Voice219"] = 8,
  ["Voice215"] = 4,
  ["priChorus"] = 0,
  ["Voice207"] = 1,
  ["modulator-25"] = 0,
  ["Voice195"] = 64,
  ["modulator-18"] = 0,
  ["Voice205"] = 0,
  ["PriInstrument"] = 37,
  ["Voice197"] = -8,
  ["Voice193"] = 32,
  ["Links"] = 0,
  ["xFadeAmount"] = 128,
  ["priSmplStartOffs"] = 0,
  ["modulator-4"] = 0,
  ["secEnvelope"] = 0,
  ["auxEnvDecay"] = 10,
  ["Voice201"] = 64,
  ["priHighKey"] = 127,
  ["lfo2Amount"] = 0,
  ["Voice203"] = 64,
  ["Voice43"] = 0,
  ["Voice175"] = 1,
  ["modulator-7"] = 0,
  ["secSmplStartOffs"] = 0,
  ["Voice47"] = 127,
  ["Voice45"] = 127,
  ["Voice185"] = 8,
  ["Voice187"] = 0,
  ["modulator-21"] = 0,
  ["secEnvDecay"] = 10,
  ["lfo1Frequency"] = 60,
  ["LFO1"] = 0,
  ["modulator-20"] = 0,
  ["patchSelect"] = 0,
  ["modulator-30"] = 0,
  ["Voice183"] = 32,
  ["xFadeBalance"] = 0,
  ["modulator-27"] = 0,
  ["priReverse"] = 0,
  ["modulator-24"] = 0,
  ["Voice51"] = 127,
  ["secChorus"] = 0,
  ["modulator-12"] = 0,
  ["modulator-17"] = 0,
  ["Voice39"] = 0,
  ["lfo2Variation"] = 0,
  ["priSolo"] = 0,
  ["modulator-22"] = 0,
  ["priEnvDelay"] = 0,
  ["lfo2Shape"] = 1,
  ["Voice49"] = 127
}
local ps = function(s)
  local i = 0
  while i < s:len() do
    LOGGER:info("%s", s:sub(i, 110))
    i = i + 110
  end
end

function setup()
  midiMessages = {}
  local midiListener = function(midiMessage)
    table.insert(midiMessages, midiMessage)
  end
  regGlobal("panel", MockPanel("Emu-Proteus2.panel", midiListener))
  onPanelBeforeLoad()
  LOGGER:setLevel(3)
end

function teardown()
end

function testOnPatchDroppedToPanel()
  loadPatchFromFile("test/data/single.syx", panel, modulatorMap, "Name1", "Solo Cello  ")
end

function testOnBankDroppedToPanel()
  loadBankFromFile(emuProteus2Controller, "test/data/PR2_BRAS.SYX", panel, trps8vaMap, "Name1", {"2 Eng.Hns.  ", "2 Trps 8va  "})
end

runTests{useANSI = false}
