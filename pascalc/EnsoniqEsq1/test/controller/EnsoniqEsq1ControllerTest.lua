require("ctrlrTestUtils")
require("Logger")
require("MockPanel")
require("controller/EnsoniqEsq1Controller")
require("controller/EnsoniqEsq1ControllerAutogen")
require("controller/onPanelBeforeLoad")
require("service/MidiService")
require 'lunity'
require 'lemock'
module( 'EnsoniqEsq1ControllerTest', lunity )

local BANK_BUFFER_SIZE = 36048

local log = Logger("EnsoniqEsq1ControllerTest")

  local modulatorMap = {
    ["ENV1-TKey"] = 9,
    ["DCA1-Mod1Amount"] = 127,
    ["ENV3-T1"] = 0,
    ["LFO2-Delay"] = 1,
    ["-GROUP-OSC2"] = 0,
    ["OSC3-Mod2Source"] = 15,
    ["OSC1-Semi"] = 0,
    ["DCA3-Level"] = 44,
    ["SplitProg"] = 14,
    ["LFO2-L1"] = 0,
    ["LayerProg"] = 0,
    ["DCA1-Enable"] = 1,
    ["Layer"] = 0,
    ["FILTER-Mod1Amount"] = 114,
    ["-GROUP-FILTER"] = 0,
    ["-GROUP-LFO3"] = 0,
    ["LFO3-Delay"] = 0,
    ["ENV1-L2"] = 72,
    ["ENV4-T1"] = 0,
    ["Split-Layer"] = 0,
    ["FILTER-KeyTrack"] = 15,
    ["ENV1-L1"] = 127,
    ["DCA1-Mod1Source"] = 4,
    ["LFO3-Reset"] = 1,
    ["DCA1-Mod2Source"] = 0,
    ["OSC1-Mod1Amount"] = 64,
    ["ENV2-L2"] = 64,
    ["LFO3-L1"] = 63,
    ["modulator-1"] = 0,
    ["OSC1-Octave"] = 4,
    ["DCA4-Pan"] = 8,
    ["LFO3-L2"] = 20,
    ["OSC3-Mod2Amount"] = 64,
    ["MODES-Cycle"] = 1,
    ["LFO1-L1"] = 0,
    ["LFO2-Reset"] = 0,
    ["ENV4-L1"] = 127,
    ["modulator-2"] = 0,
    ["FILTER-Frequency"] = 15,
    ["LFO2-L2"] = 20,
    ["MODES-Sync"] = 0,
    ["ENV3-L3"] = 64,
    ["MODES-Mono"] = 0,
    ["LFO3-Wave"] = 2,
    ["ENV2-LVel"] = 0,
    ["LFO1-L2"] = 20,
    ["-GROUP-ENV1"] = 0,
    ["FILTER-Mod2Source"] = 0,
    ["ENV4-T2"] = 37,
    ["MODES-EnvReset"] = 0,
    ["-GROUP-ENV3"] = 0,
    ["OSC1-Mod2Source"] = 15,
    ["DCA1-Level"] = 15,
    ["DCA2-Mod1Amount"] = 94,
    ["-GROUP-OSC1"] = 0,
    ["-GROUP-ENV4"] = 0,
    ["ENV3-T2"] = 16,
    ["-GROUP-DCA3"] = 0,
    ["MODES-AM"] = 0,
    ["ENV1-L3"] = 84,
    ["OSC2-Mod2Amount"] = 64,
    ["ENV1-T3"] = 63,
    ["ENV3-TKey"] = 9,
    ["LFO2-Human"] = 0,
    ["OSC2-Octave"] = 6,
    ["FILTER-Q"] = 2,
    ["DCA2-Level"] = 55,
    ["OSC3-Semi"] = 0,
    ["DCA2-Mod2Amount"] = 64,
    ["ENV2-T2"] = 27,
    ["LFO1-Wave"] = 0,
    ["DCA3-Enable"] = 1,
    ["ENV2-T1Vel"] = 0,
    ["LFO2-ModSource"] = 11,
    ["SplitPnt"] = 175,
    ["FILTER-Mod1Source"] = 5,
    ["OSC3-Fine"] = 0,
    ["ENV3-LVel"] = 0,
    ["LFO3-ModSource"] = 11,
    ["Name1"] = 0,
    ["patchSelect"] = 0,
    ["OSC3-Mod1Amount"] = 64,
    ["modulator-4"] = 0,
    ["Split-LayerProg"] = 0,
    ["ENV1-T4"] = 20,
    ["ENV1-T1"] = 0,
    ["LFO3-Human"] = 0,
    ["modulator-3"] = 0,
    ["LFO1-Reset"] = 0,
    ["-GROUP-1"] = 0,
    ["OSC3-Wave"] = 1,
    ["ENV4-T1Vel"] = 0,
    ["OSC3-Octave"] = 3,
    ["-GROUP-LFO1"] = 0,
    ["Split"] = 0,
    ["modulator-6"] = 0,
    ["-GROUP-OSC3"] = 0,
    ["DCA2-Mod1Source"] = 4,
    ["OSC2-Mod1Source"] = 0,
    ["LFO3-Freq"] = 1,
    ["OSC2-Mod2Source"] = 2,
    ["OSC2-Semi"] = 0,
    ["ENV2-L1"] = 127,
    ["LFO1-Human"] = 0,
    ["ENV2-T1"] = 0,
    ["ENV4-T4"] = 23,
    ["OSC2-Fine"] = 2,
    ["OSC2-Mod1Amount"] = 64,
    ["ENV3-T3"] = 20,
    ["ENV4-L3"] = 64,
    ["ENV2-TKey"] = 9,
    ["DCA4-PanModSource"] = 14,
    ["ENV2-L3"] = 64,
    ["ENV1-T1Vel"] = 0,
    ["DCA3-Mod1Amount"] = 70,
    ["DCA3-Mod2Source"] = 0,
    ["OSC1-Wave"] = 6,
    ["DCA4-Env4Amount"] = 126,
    ["OSC1-Mod1Source"] = 15,
    ["DCA3-Mod2Amount"] = 64,
    ["ENV4-TKey"] = 0,
    ["ENV1-LVel"] = 0,
    ["DCA2-Enable"] = 1,
    ["DCA4-PanModAmount"] = 64,
    ["ENV3-T4"] = 32,
    ["FILTER-Mod2Amount"] = 64,
    ["LFO2-Freq"] = 16,
    ["DCA2-Mod2Source"] = 0,
    ["ENV4-LVel"] = 0,
    ["ENV3-L1"] = 127,
    ["MODES-Rotate"] = 1,
    ["DCA1-Mod2Amount"] = 64,
    ["OSC1-Mod2Amount"] = 64,
    ["-GROUP-DCA1"] = 0,
    ["-GROUP-DCA2"] = 0,
    ["LFO1-Delay"] = 1,
    ["DCA3-Mod1Source"] = 6,
    ["MODES-Glide"] = 0,
    ["ENV4-T3"] = 0,
    ["ENV4-L2"] = 64,
    ["ENV1-T2"] = 50,
    ["OSC2-Wave"] = 6,
    ["LFO2-Wave"] = 2,
    ["-GROUP-LFO2"] = 0,
    ["-GROUP-DCA4"] = 0,
    ["OSC3-Mod1Source"] = 0,
    ["ENV3-T1Vel"] = 0,
    ["ENV2-T3"] = 0,
    ["LFO1-Freq"] = 14,
    ["ENV2-T4"] = 20,
    ["OSC1-Fine"] = 0,
    ["-GROUP-ENV2"] = 0,
    ["LFO1-ModSource"] = 11,
    ["ENV3-L2"] = 79,
    ["MODES-WaveReset"] = 1
  }

local digpnoMap = {
["ENV1-TKey"] = 9,
["DCA1-Mod1Amount"] = 64,
["ENV3-T1"] = 0,
["LFO2-Delay"] = 1,
["-GROUP-OSC2"] = 0,
["OSC3-Mod2Source"] = 10,
["OSC1-Semi"] = 0,
["DCA3-Level"] = 0,
["SplitProg"] = 0,
["LFO2-L1"] = 0,
["LayerProg"] = 0,
["DCA1-Enable"] = 1,
["Layer"] = 0,
["FILTER-Mod1Amount"] = 126,
["-GROUP-FILTER"] = 0,
["-GROUP-LFO3"] = 0,
["LFO3-Delay"] = 0,
["ENV1-L2"] = 72,
["ENV4-T1"] = 0,
["Split-Layer"] = 0,
["FILTER-KeyTrack"] = 7,
["ENV1-L1"] = 127,
["DCA1-Mod1Source"] = 4,
["LFO3-Reset"] = 1,
["DCA1-Mod2Source"] = 15,
["OSC1-Mod1Amount"] = 64,
["ENV2-L2"] = 65,
["LFO3-L1"] = 63,
["modulator-1"] = 0,
["OSC1-Octave"] = 2,
["DCA4-Pan"] = 8,
["LFO3-L2"] = 20,
["OSC3-Mod2Amount"] = 1,
["MODES-Cycle"] = 0,
["LFO1-L1"] = 0,
["LFO2-Reset"] = 0,
["ENV4-L1"] = 127,
["modulator-2"] = 0,
["FILTER-Frequency"] = 37,
["LFO2-L2"] = 20,
["MODES-Sync"] = 0,
["ENV3-L3"] = 70,
["MODES-Mono"] = 0,
["LFO3-Wave"] = 2,
["ENV2-LVel"] = 30,
["LFO1-L2"] = 0,
["-GROUP-ENV1"] = 0,
["FILTER-Mod2Source"] = 10,
["ENV4-T2"] = 44,
["MODES-EnvReset"] = 1,
["-GROUP-ENV3"] = 0,
["OSC1-Mod2Source"] = 15,
["DCA1-Level"] = 56,
["DCA2-Mod1Amount"] = 64,
["-GROUP-OSC1"] = 0,
["-GROUP-ENV4"] = 0,
["ENV3-T2"] = 44,
["-GROUP-DCA3"] = 0,
["MODES-AM"] = 0,
["ENV1-L3"] = 84,
["OSC2-Mod2Amount"] = 64,
["ENV1-T3"] = 63,
["ENV3-TKey"] = 56,
["LFO2-Human"] = 0,
["OSC2-Octave"] = 2,
["FILTER-Q"] = 0,
["DCA2-Level"] = 56,
["OSC3-Semi"] = 0,
["DCA2-Mod2Amount"] = 64,
["ENV2-T2"] = 13,
["LFO1-Wave"] = 0,
["DCA3-Enable"] = 1,
["ENV2-T1Vel"] = 0,
["LFO2-ModSource"] = 11,
["SplitPnt"] = 0,
["FILTER-Mod1Source"] = 5,
["OSC3-Fine"] = 0,
["ENV3-LVel"] = 63,
["LFO3-ModSource"] = 15,
["Name1"] = 0,
["patchSelect"] = 0,
["OSC3-Mod1Amount"] = 64,
["modulator-4"] = 0,
["Split-LayerProg"] = 0,
["ENV1-T4"] = 20,
["ENV1-T1"] = 0,
["LFO3-Human"] = 0,
["modulator-3"] = 0,
["LFO1-Reset"] = 1,
["-GROUP-1"] = 0,
["OSC3-Wave"] = 18,
["ENV4-T1Vel"] = 0,
["OSC3-Octave"] = 0,
["-GROUP-LFO1"] = 0,
["Split"] = 0,
["modulator-6"] = 0,
["-GROUP-OSC3"] = 0,
["DCA2-Mod1Source"] = 4,
["OSC2-Mod1Source"] = 11,
["LFO3-Freq"] = 0,
["OSC2-Mod2Source"] = 15,
["OSC2-Semi"] = 0,
["ENV2-L1"] = 127,
["LFO1-Human"] = 0,
["ENV2-T1"] = 0,
["ENV4-T4"] = 24,
["OSC2-Fine"] = 1,
["OSC2-Mod1Amount"] = 65,
["ENV3-T3"] = 63,
["ENV4-L3"] = 64,
["ENV2-TKey"] = 0,
["DCA4-PanModSource"] = 10,
["ENV2-L3"] = 64,
["ENV1-T1Vel"] = 0,
["DCA3-Mod1Amount"] = 124,
["DCA3-Mod2Source"] = 15,
["OSC1-Wave"] = 9,
["DCA4-Env4Amount"] = 126,
["OSC1-Mod1Source"] = 15,
["DCA3-Mod2Amount"] = 64,
["ENV4-TKey"] = 46,
["ENV1-LVel"] = 0,
["DCA2-Enable"] = 1,
["DCA4-PanModAmount"] = 91,
["ENV3-T4"] = 26,
["FILTER-Mod2Amount"] = 74,
["LFO2-Freq"] = 1,
["DCA2-Mod2Source"] = 15,
["ENV4-LVel"] = 51,
["ENV3-L1"] = 127,
["MODES-Rotate"] = 1,
["DCA1-Mod2Amount"] = 64,
["OSC1-Mod2Amount"] = 64,
["-GROUP-DCA1"] = 0,
["-GROUP-DCA2"] = 0,
["LFO1-Delay"] = 1,
["DCA3-Mod1Source"] = 4,
["MODES-Glide"] = 0,
["ENV4-T3"] = 63,
["ENV4-L2"] = 107,
["ENV1-T2"] = 50,
["OSC2-Wave"] = 9,
["LFO2-Wave"] = 2,
["-GROUP-LFO2"] = 0,
["-GROUP-DCA4"] = 0,
["OSC3-Mod1Source"] = 15,
["ENV3-T1Vel"] = 0,
["ENV2-T3"] = 63,
["LFO1-Freq"] = 20,
["ENV2-T4"] = 0,
["OSC1-Fine"] = 0,
["-GROUP-ENV2"] = 0,
["LFO1-ModSource"] = 11,
["ENV3-L2"] = 100,
["MODES-WaveReset"] = 1
}
function setup()
  local log = Logger("GLOBAL")
  log:setLevel(3)
  regGlobal("LOGGER", log)

  midiMessages = {}
  local midiListener = function(midiMessage)
    table.insert(midiMessages, midiMessage)
  end
  regGlobal("panel", MockPanel("Ensoniq-ESQ1.panel", midiListener))
  onPanelBeforeLoad()
end

function teardown()
  delGlobal("midiService")
end

function testOnPatchDroppedToPanel()
  loadPatchFromFile("test/data/SNADRM-ESQ1.syx", panel, modulatorMap, "Name1", "SNADRM")
end

function testOnBankDroppedToPanel()
  loadBankFromFile(ensoniqEsq1Controller, "C:/ctrlr/syxfiles/EnsoniqESQ1/Esqhits^2.syx", panel, digpnoMap, "Name1", {"PIANO2", "DIGPNO"})
end

function testOnMidiReceived()
  local tested = EnsoniqEsq1Controller()
  tested:onMidiReceived(CtrlrMidiMessage(MemoryBlock("f0 0f 02 00 01 0d 04 09 04 08 05 05 04 04 04 00 02 0e 07 02 08 00 00 00 00 0f 00 07 02 07 02 02 00 00 00 09 00 0e 07 00 00 00 00 00 00 06 02 01 00 0a 02 00 00 00 00 00 00 0e 07 0e 07 0e 07 0e 00 02 03 0f 03 0b 02 00 00 00 00 09 00 0a 07 08 07 0e 06 09 01 08 01 0f 03 04 02 06 03 01 01 00 00 08 01 00 08 0f 0f 00 04 05 01 00 00 0f 03 0f 07 0a 00 0f 0f 0f 0f 0f 07 04 02 00 02 01 00 02 00 02 00 0b 00 08 0f 04 0f 0e 07 00 00 04 02 08 01 01 00 04 00 06 00 0b 00 08 0f 0f 0f 00 00 00 00 04 02 00 00 01 00 0e 0f 04 00 0b 00 08 0f 0f 0f 00 00 00 00 0c 06 00 00 00 00 06 05 0b 0a 0f 03 06 05 00 00 0e 03 03 06 0e 06 00 00 02 08 0e 01 f7")))
end

runTests{useANSI = false}
