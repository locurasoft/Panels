require("ctrlrTestUtils")
require("Logger")
require("MockPanel")
require("model/RolandD50Bank")
require("service/MidiService")
require("controller/RolandD50Controller")
require("controller/RolandD50ControllerAutogen")
require("controller/onPanelBeforeLoad")
require 'lunity'
require 'lemock'
module( 'RolandD50ControllerTest', lunity )

local BANK_BUFFER_SIZE = 36048

local log = Logger("RolandD50ControllerTest")

local modulatorMap = {
  ["Voice429"] = 98,
  ["lP1TvfAtRng"] = 0,
  ["envelope1234567"] = 0,
  ["lP2TvaBiasLevel"] = 12,
  ["lChorusBalance"] = 0,
  ["WGPITCH123"] = 0,
  ["uP2TvaEnvSust"] = 0,
  ["uP2LfoSelect"] = 0,
  ["uLfo3Waveform"] = 0,
  ["uChorusBalance"] = 0,
  ["Chorus"] = 0,
  ["lP1TvaEnvEnd"] = 0,
  ["lP1LfoSelect"] = 0,
  ["lP2AtRng"] = 0,
  ["Voice252"] = 98,
  ["Voice314"] = 98,
  ["lP2TvaEnvSust"] = 0,
  ["lP2LfoSelect"] = 0,
  ["uP1LfoSelect"] = 0,
  ["Voice126"] = 98,
  ["lP2LfoDepth"] = 100,
  ["uChorusDepth"] = 0,
  ["Voice327"] = 29,
  ["uLfo1DelayTime"] = 0,
  ["lPitchAfterTouch"] = 23,
  ["uP2LfoDepth"] = 100,
  ["uP2AtRng"] = 0,
  ["LFO11"] = 0,
  ["Voice246"] = 98,
  ["uP2TvfAtRng"] = 0,
  ["uLfo3Sync"] = 1,
  ["lLfo2Waveform"] = 0,
  ["Voice370"] = 98,
  ["uP2TvfVelRng"] = 100,
  ["Voice310"] = 98,
  ["uLfo2Waveform"] = 0,
  ["lP2TvfVelRng"] = 100,
  ["Voice179"] = 98,
  ["Voice439"] = 98,
  ["uLfo1Waveform"] = 0,
  ["lLfo1Waveform"] = 0,
  ["Voice329"] = 44,
  ["lP1TvaBiasLevel"] = 12,
  ["toneBalance"] = 50,
  ["outputMode"] = 0,
  ["uP1TvaTimeKf"] = 0,
  ["lP1TvaEnvT4"] = 0,
  ["Voice184"] = 98,
  ["Voice320"] = 4,
  ["lP2TvfEnvEnd"] = 0,
  ["lToneFineTune"] = 0,
  ["LFO3"] = 0,
  ["uP1TvaBiasPnt"] = 95,
  ["uP1TvaEnvT1"] = 0,
  ["lPitchEnvT2"] = 20,
  ["uToneFineTune"] = 0,
  ["Voice137"] = 44,
  ["lP1AtRng"] = 0,
  ["Voice255"] = 98,
  ["PITCHENV"] = 0,
  ["modulator-3"] = 0,
  ["Voice121"] = 98,
  ["lP2TvfEnvSust"] = 29,
  ["uLfo3Rate"] = 22,
  ["lP1TvaKfTime"] = 0,
  ["Voice394"] = 12,
  ["envelope1"] = 0,
  ["uP2TvfEnvSust"] = 29,
  ["lP1TvfEnvEnd"] = 0,
  ["lLfo3Rate"] = 22,
  ["lLfo1Rate"] = 12,
  ["lPartialBalance"] = 50,
  ["lPitchEnvEnd"] = 0,
  ["uLfo1Rate"] = 12,
  ["uPartialBalance"] = 50,
  ["lPitchEnvLvl1"] = 0,
  ["uPitchEnvEnd"] = 0,
  ["uP2TvaEnvT4"] = 0,
  ["TVA"] = 0,
  ["lP2TvaEnvT4"] = 0,
  ["Voice391"] = 39,
  ["uP1PitchFine"] = 5,
  ["lP1PitchFine"] = -5,
  ["lP2TvaKfTime"] = 0,
  ["Voice315"] = 98,
  ["lP1TvfResonance"] = 30,
  ["upperPartial1PCM"] = 0,
  ["Voice56"] = 98,
  ["uP1TvfResonance"] = 30,
  ["TVF123"] = 0,
  ["uP2TvfEnvLvl2"] = 75,
  ["uPitchEnvT2"] = 20,
  ["lP1TvaEnvSust"] = 0,
  ["Voice316"] = 98,
  ["lP2TvaBiasPnt"] = 95,
  ["uP1TvaEnvSust"] = 0,
  ["lP1TvaBiasPnt"] = 95,
  ["Voice248"] = 98,
  ["lP1TvaEnvT1"] = 0,
  ["lP2TvfEnvLvl2"] = 75,
  ["Voice393"] = 0,
  ["lP1TvfBiasLvl"] = 0,
  ["uP2TvfResonance"] = 30,
  ["uP1PitchCoarse"] = 12,
  ["Voice177"] = 98,
  ["uP1TvfEnvLvl3"] = 42,
  ["uP1TvfBiasLvl"] = 0,
  ["uP2PitchCoarse"] = 12,
  ["Voice436"] = 98,
  ["uP1TvaAtRng"] = 0,
  ["lP2TvfEnvLvl1"] = 100,
  ["lP1TvfEnvLvl3"] = 42,
  ["Voice437"] = 98,
  ["Voice57"] = 98,
  ["uP2TvfLfoDepth"] = 75,
  ["uP2TvfEnvLvl1"] = 100,
  ["lP1TvaAtRng"] = 0,
  ["envelope1234567891011121314151617"] = 0,
  ["uP1TvfVelRng"] = 100,
  ["Voice381"] = 98,
  ["chaseMode"] = 2,
  ["lP1TvaVelRng"] = 0,
  ["uP2TvfLfoSel"] = 0,
  ["lP1TvfVelRng"] = 100,
  ["modulator-9"] = 0,
  ["Voice435"] = 98,
  ["holdMode"] = 2,
  ["lP2PitchCoarse"] = 12,
  ["Voice313"] = 98,
  ["uP1TvaVelRng"] = 0,
  ["uP1TvfCutoff"] = 45,
  ["uP1TvfEnvLvl1"] = 100,
  ["lP2TvfEnvT1"] = 0,
  ["lP1TvfEnvT4"] = 48,
  ["lP2TvaVelRng"] = 0,
  ["uP2TvfEnvT1"] = 0,
  ["lP1TvaEnvT3"] = 67,
  ["uP2TvaAtRng"] = 0,
  ["uP1TvfDepth"] = 30,
  ["lP2TvaEnvT5"] = 15,
  ["Voice59"] = 98,
  ["uPitchEnvLvl2"] = 0,
  ["uP2TvaVelKf"] = 0,
  ["UpperPartial1"] = 0,
  ["uP2TvaEnvT3"] = 67,
  ["lP2TvaAtRng"] = 0,
  ["uP1TvfTimeKf"] = 0,
  ["uP1TvaEnvT3"] = 67,
  ["lPitchEnvLvl2"] = 0,
  ["lP1PitchCoarse"] = 12,
  ["uP1TvfLfoSel"] = 0,
  ["lP1TvfEnvSust"] = 29,
  ["atBlendRange"] = -12,
  ["Voice263"] = 67,
  ["uP1TvfEnvSust"] = 29,
  ["Voice326"] = 31,
  ["Load"] = 0,
  ["lP2TvfResonance"] = 30,
  ["lP1TvfEnvT1"] = 0,
  ["uP2TvfDepth"] = 30,
  ["lP1TvfLfoSelect"] = 0,
  ["reverbType"] = 11,
  ["uP1TvaVelKf"] = 0,
  ["uP1TvfEnvT1"] = 0,
  ["envelope1234567891011"] = 0,
  ["Voice433"] = 98,
  ["uP1TvaLvl"] = 100,
  ["lP2LfoMode"] = 3,
  ["envelope12345678910111213141516171819"] = 0,
  ["uP2LfoMode"] = 3,
  ["lP2TvfDepth"] = 30,
  ["Voice389"] = 40,
  ["Voice398"] = 0,
  ["uP2TvfEnvT2"] = 24,
  ["Voice190"] = 98,
  ["Partial2Upper"] = 0,
  ["lPitchEnvT3"] = 20,
  ["lP2TvfEnvT2"] = 24,
  ["uP2BenderMode"] = 1,
  ["uPitchEnvT3"] = 20,
  ["Partial1Lower"] = 0,
  ["LowerPartial2"] = 1,
  ["Voice181"] = 98,
  ["lP1TvfCutoff"] = 45,
  ["Voice427"] = 98,
  ["uP1LfoMode"] = 1,
  ["uP1TvfLfoDepth"] = 75,
  ["Voice130"] = 3,
  ["Voice189"] = 98,
  ["lChorusDepth"] = 0,
  ["uP1TvaEnvLvl3"] = 0,
  ["lP1TvaEnvLvl2"] = 0,
  ["Voice132"] = 38,
  ["upperStructure"] = 0,
  ["chaseTime"] = 50,
  ["uP1TvaEnvLvl2"] = 0,
  ["uP2TvaTimeKf"] = 0,
  ["Voice62"] = 98,
  ["lP1TvfLfoDepth"] = 75,
  ["uP1TvaEnvT2"] = 97,
  ["uP1LfoDepth"] = 100,
  ["uP1BenderMode"] = 1,
  ["Voice396"] = 15,
  ["lP1BenderMode"] = 1,
  ["lP1TvaEnvT2"] = 97,
  ["lP1LfoDepth"] = 100,
  ["Voice127"] = 98,
  ["combinedGroup1"] = 0,
  ["lP1TvaLevel"] = 100,
  ["Patch"] = 0,
  ["Name1"] = 0,
  ["uLowGain"] = 12,
  ["uP1TvfDepthKf"] = 0,
  ["lP2TvfEnvT5"] = 48,
  ["lP2TvfBiasLevel"] = 0,
  ["Voice378"] = 98,
  ["lP2TvfKf"] = 7,
  ["uP2TvaLfoSel"] = 0,
  ["lHighGain"] = 2,
  ["Partial1Upper"] = 0,
  ["Voice375"] = 98,
  ["uP2TvfEnvT5"] = 48,
  ["uHighGain"] = 2,
  ["chaseLevel"] = 50,
  ["envelope123"] = 0,
  ["modulator-1"] = 0,
  ["Voice386"] = 55,
  ["lP1TvaLfoSelect"] = 0,
  ["CommonUpper"] = 0,
  ["lP2TvaLfoSelect"] = 0,
  ["Voice180"] = 98,
  ["uHighFreq"] = 11,
  ["uChorusRate"] = 24,
  ["Voice134"] = 31,
  ["lHighFreq"] = 11,
  ["uP1TvfEnvT5"] = 48,
  ["uLfo3DelayTime"] = 0,
  ["Voice385"] = 62,
  ["lP1TvfEnvT5"] = 48,
  ["Voice368"] = 98,
  ["Voice128"] = 4,
  ["uPitchVelRng"] = 0,
  ["lP1TvfKfTime"] = 0,
  ["lP2TvaEnvLvl2"] = 0,
  ["lLfo3DelayTime"] = 0,
  ["lP1TvaKfVel"] = 0,
  ["uP2TvfEnvT3"] = 40,
  ["lChorusRate"] = 24,
  ["uP2TvaEnvLvl2"] = 0,
  ["lP2TvfEnvT3"] = 40,
  ["lowerPartial1PCM"] = 0,
  ["Voice399"] = 0,
  ["Voice312"] = 98,
  ["portamentoTime"] = 64,
  ["uP2PKeyfollow"] = 11,
  ["Voice383"] = 98,
  ["lP2PEnvMode"] = 0,
  ["uP2TvfTimeKf"] = 0,
  ["LowEQ1"] = 0,
  ["lP2TvfBiasPnt"] = 27,
  ["Voice384"] = 55,
  ["envelope123456789"] = 0,
  ["lP1PulseWidth"] = 100,
  ["lP1PKeyfollow"] = 11,
  ["uP2TvfBiasPnt"] = 27,
  ["lowerPartial2PCM"] = 0,
  ["Voice176"] = 98,
  ["uP1PulseWidth"] = 100,
  ["uP1TvfBiasPnt"] = 27,
  ["Voice188"] = 98,
  ["LowEQ"] = 0,
  ["uP2PulseWidth"] = 100,
  ["Voice380"] = 98,
  ["lPitchEnvSust"] = 0,
  ["uP1TvfEnvT4"] = 48,
  ["uP1PKeyfollow"] = 11,
  ["lP2PKeyfollow"] = 11,
  ["uP2TvfDepthKf"] = 0,
  ["Voice54"] = 98,
  ["lP1TvfEnvLvl1"] = 100,
  ["Voice55"] = 98,
  ["uP1TvaLfoDepth"] = 60,
  ["patchSelect"] = 0,
  ["Voice119"] = 98,
  ["Voice120"] = 98,
  ["uP2TvfEnvLvl3"] = 42,
  ["uP2TvaEnvLvl3"] = 0,
  ["uP1TvfEnvT3"] = 40,
  ["TVA1"] = 0,
  ["Voice71"] = 67,
  ["lP2TvfEnvLvl3"] = 42,
  ["uLfo2DelayTime"] = 0,
  ["Voice136"] = 46,
  ["Voice372"] = 98,
  ["toneSelector"] = 0,
  ["lLfo2DelayTime"] = 0,
  ["lP1TvfKfDepth"] = 0,
  ["uP1TvfEnvT2"] = 24,
  ["lP2TvaEnvLvl3"] = 0,
  ["Voice376"] = 98,
  ["uP1TvaLfoSel"] = 0,
  ["uPitchEnvLvl0"] = 0,
  ["lP1TvfEnvT2"] = 24,
  ["LFO2"] = 0,
  ["lP2TvaLfoDepth"] = 60,
  ["uP2TvaBiasLvl"] = 12,
  ["uP2TvfBiasLvl"] = 0,
  ["Voice392"] = 51,
  ["Voice251"] = 98,
  ["uP1TvfKeyfollow"] = 7,
  ["uP2TvaLfoDepth"] = 60,
  ["lP1TvaEnvT5"] = 15,
  ["uPitchEnvT1"] = 20,
  ["Voice428"] = 98,
  ["HighEQ1"] = 0,
  ["Voice430"] = 98,
  ["uLfo2Sync"] = 0,
  ["Voice400"] = 0,
  ["uP2TvfKeyfollow"] = 7,
  ["lLfo2Sync"] = 0,
  ["uLowFreq"] = 1,
  ["Voice324"] = 38,
  ["lLowFreq"] = 1,
  ["Voice60"] = 98,
  ["lChorusType"] = 0,
  ["HighEQ"] = 0,
  ["lP2TvaEnvEnd"] = 0,
  ["lPitchLFODepth"] = 0,
  ["lP1TvaLfoDepth"] = 60,
  ["uP2TvaEnvEnd"] = 0,
  ["uPitchLFODepth"] = 0,
  ["uChorusType"] = 0,
  ["keyMode"] = 0,
  ["uPitchEnvT4"] = 20,
  ["upperPartial1PCM-1"] = 0,
  ["modulator-12"] = 0,
  ["lPitchVelRng"] = 0,
  ["uP1TvfEnvLvl2"] = 75,
  ["Voice125"] = 98,
  ["UpperPartial2"] = 1,
  ["modulator-8"] = 0,
  ["modulator-7"] = 0,
  ["portamentoMode"] = 2,
  ["modulator-5"] = 0,
  ["LFOUpper"] = 0,
  ["lP2Waveform"] = 0,
  ["lP1TvfEnvLvl2"] = 75,
  ["Voice447"] = 98,
  ["envelope123456789101112131415"] = 0,
  ["LFO21"] = 0,
  ["Voice425"] = 98,
  ["uP2PitchFine"] = 5,
  ["uPitchEnvLvl1"] = 0,
  ["Voice444"] = 98,
  ["lP2TvaLevel"] = 100,
  ["lPitchEnvT4"] = 20,
  ["Voice443"] = 98,
  ["lPitchLever"] = 47,
  ["lP2PitchFine"] = -5,
  ["Voice442"] = 98,
  ["Voice183"] = 98,
  ["Voice182"] = 98,
  ["Voice118"] = 98,
  ["lLowGain"] = 12,
  ["Voice440"] = 98,
  ["uP1VelRng"] = 0,
  ["Voice379"] = 98,
  ["Voice438"] = 98,
  ["Voice135"] = 29,
  ["uP1TvaEnvEnd"] = 0,
  ["lLfo3Waveform"] = 0,
  ["LFO1"] = 0,
  ["Voice434"] = 98,
  ["Voice432"] = 98,
  ["Voice129"] = 63,
  ["Voice388"] = 35,
  ["uP1TvaEnvT5"] = 15,
  ["Voice319"] = 98,
  ["uP1TvfAtRgn"] = 0,
  ["lPitchEnvT1"] = 20,
  ["Voice131"] = 41,
  ["Voice185"] = 98,
  ["WGPITCH1"] = 0,
  ["Voice247"] = 98,
  ["lLfo1DelayTime"] = 0,
  ["Chorus1"] = 0,
  ["lP1VelRng"] = 0,
  ["Voice426"] = 98,
  ["benderRange"] = 2,
  ["Voice424"] = 98,
  ["Voice321"] = 63,
  ["VoiceName123"] = 0,
  ["PITCHENV1"] = 0,
  ["Voice422"] = 98,
  ["Voice421"] = 98,
  ["lP2TvfAtRng"] = 0,
  ["Voice446"] = 98,
  ["Voice250"] = 98,
  ["envelope12345678910111213"] = 0,
  ["modulator-10"] = 0,
  ["lP2TvfLfoSelect"] = 0,
  ["Voice58"] = 98,
  ["uLfo1Sync"] = 0,
  ["uP1TvaEnvLvl1"] = 100,
  ["Voice401"] = 0,
  ["Voice369"] = 98,
  ["Voice186"] = 98,
  ["lP1Waveform"] = 0,
  ["lP2TvaEnvT2"] = 97,
  ["Voice124"] = 98,
  ["TVF12"] = 0,
  ["Voice374"] = 98,
  ["Save"] = 0,
  ["Voice373"] = 98,
  ["uP1TvaEnvT4"] = 0,
  ["Voice371"] = 98,
  ["Voice431"] = 98,
  ["uP2TvaEnvT2"] = 97,
  ["Voice318"] = 98,
  ["Voice317"] = 98,
  ["lP2PulseWidth"] = 100,
  ["lP2TvfKfTime"] = 0,
  ["lP2TvaEnvLvl1"] = 100,
  ["lP2TvaEnvT1"] = 0,
  ["Voice_globalPatchControls"] = 0,
  ["LFOLower"] = 0,
  ["Voice249"] = 98,
  ["uP1AtRng"] = 0,
  ["lP1PEnvMode"] = 0,
  ["Voice254"] = 98,
  ["Voice253"] = 98,
  ["Voice323"] = 41,
  ["uP2TvaEnvT1"] = 0,
  ["uP2TvfEnvEnd"] = 0,
  ["Voice63"] = 98,
  ["LFO31"] = 0,
  ["TVA123"] = 0,
  ["lP2BenderMode"] = 1,
  ["uP2PEnvMode"] = 0,
  ["splitPoint"] = 29,
  ["lP1TvfKf"] = 7,
  ["Voice191"] = 98,
  ["lP1TvfBiasPnt"] = 27,
  ["Voice397"] = 0,
  ["Voice187"] = 98,
  ["uP2TvaEnvLvl1"] = 100,
  ["Voice325"] = 38,
  ["lP1TvaEnvLvl1"] = 100,
  ["TVF1"] = 0,
  ["WGPITCH"] = 0,
  ["TVF"] = 0,
  ["uPitchEnvSust"] = 0,
  ["Voice441"] = 98,
  ["uP1PEnvMode"] = 0,
  ["lP2TvfLfoDepth"] = 75,
  ["uP1TvfEnvEnd"] = 0,
  ["Voice178"] = 98,
  ["uPitchAfterTouch"] = 23,
  ["modulator-6"] = 0,
  ["Voice123"] = 98,
  ["lP1TvfEnvT3"] = 40,
  ["uLfo2Rate"] = 25,
  ["Voice395"] = 6,
  ["uP1TvaBiasLvl"] = 12,
  ["Voice61"] = 98,
  ["Voice382"] = 98,
  ["uP2TvfCutoff"] = 45,
  ["Voice7"] = 49,
  ["Voice377"] = 98,
  ["lPitchEnvLvl0"] = 0,
  ["Voice328"] = 46,
  ["Voice387"] = 0,
  ["uP2TvaBiasPnt"] = 95,
  ["uP2Waveform"] = 0,
  ["Voice390"] = 0,
  ["Voice322"] = 3,
  ["Voice133"] = 38,
  ["lP2VelRng"] = 0,
  ["Voice423"] = 98,
  ["lLfo1Sync"] = 0,
  ["modulator-4"] = 0,
  ["lStructure"] = 0,
  ["uP2VelRng"] = 0,
  ["Partial2Lower"] = 0,
  ["envelope12345"] = 0,
  ["lPitchTimeKeyfollow"] = 0,
  ["VoiceName12"] = 0,
  ["CommonLower"] = 0,
  ["Voice311"] = 98,
  ["uToneKeyShft"] = 0,
  ["lP1LfoMode"] = 1,
  ["reverbBalance"] = 25,
  ["lP2TvaEnvT3"] = 67,
  ["lP2TvfKfDepth"] = 0,
  ["Voice199"] = 49,
  ["WGPITCH12"] = 0,
  ["uP1Waveform"] = 0,
  ["lHighQ"] = 0,
  ["uP2TvaEnvT5"] = 15,
  ["uLever"] = 47,
  ["lP2TvaKfVelocity"] = 0,
  ["uP2TvaVelRng"] = 0,
  ["uHighQ"] = 0,
  ["uP2TvaLvl"] = 100,
  ["Voice122"] = 98,
  ["Voice445"] = 98,
  ["lP2TvfCutoff"] = 45,
  ["lP1TvaEnvLvl3"] = 0,
  ["totalVolume"] = 100,
  ["uPitchTimeKeyfollow"] = 0,
  ["lP1TvfDepth"] = 30,
  ["lP2TvfEnvT4"] = 48,
  ["lToneKeyShft"] = 0,
  ["LowerPartial1"] = 0,
  ["TVA12"] = 0,
  ["lLfo3Sync"] = 1,
  ["lLfo2Rate"] = 25,
  ["uP2TvfEnvT4"] = 48
}

local _303Map = {
  ["Voice429"] = 15,
  ["lP1TvfAtRng"] = 0,
  ["envelope1234567"] = 0,
  ["lP2TvaBiasLevel"] = 12,
  ["lChorusBalance"] = 29,
  ["WGPITCH123"] = 0,
  ["uP2TvaEnvSust"] = 0,
  ["uP2LfoSelect"] = 2,
  ["uLfo3Waveform"] = 0,
  ["uChorusBalance"] = 80,
  ["Chorus"] = 0,
  ["lP1TvaEnvEnd"] = 0,
  ["lP1LfoSelect"] = 2,
  ["lP2AtRng"] = 0,
  ["Voice252"] = 0,
  ["Voice314"] = 0,
  ["lP2TvaEnvSust"] = 0,
  ["lP2LfoSelect"] = 2,
  ["uP1LfoSelect"] = 2,
  ["Voice126"] = 0,
  ["lP2LfoDepth"] = 0,
  ["uChorusDepth"] = 75,
  ["Voice327"] = 29,
  ["uLfo1DelayTime"] = 0,
  ["lPitchAfterTouch"] = 23,
  ["uP2LfoDepth"] = 0,
  ["uP2AtRng"] = 0,
  ["LFO11"] = 0,
  ["Voice246"] = 0,
  ["uP2TvfAtRng"] = 0,
  ["uLfo3Sync"] = 1,
  ["lLfo2Waveform"] = 0,
  ["Voice370"] = 0,
  ["uP2TvfVelRng"] = 100,
  ["Voice310"] = 0,
  ["uLfo2Waveform"] = 0,
  ["lP2TvfVelRng"] = 100,
  ["Voice179"] = 0,
  ["Voice439"] = 0,
  ["uLfo1Waveform"] = 0,
  ["lLfo1Waveform"] = 0,
  ["Voice329"] = 44,
  ["lP1TvaBiasLevel"] = 12,
  ["toneBalance"] = 50,
  ["outputMode"] = 0,
  ["uP1TvaTimeKf"] = 0,
  ["lP1TvaEnvT4"] = 0,
  ["Voice184"] = 0,
  ["Voice320"] = 4,
  ["lP2TvfEnvEnd"] = 0,
  ["lToneFineTune"] = 0,
  ["LFO3"] = 0,
  ["uP1TvaBiasPnt"] = 95,
  ["uP1TvaEnvT1"] = 15,
  ["lPitchEnvT2"] = 20,
  ["uToneFineTune"] = 0,
  ["Voice137"] = 44,
  ["lP1AtRng"] = 0,
  ["Voice255"] = 0,
  ["PITCHENV"] = 0,
  ["modulator-3"] = 0,
  ["Voice121"] = 0,
  ["lP2TvfEnvSust"] = 29,
  ["uLfo3Rate"] = 22,
  ["lP1TvaKfTime"] = 0,
  ["Voice394"] = 0,
  ["envelope1"] = 0,
  ["uP2TvfEnvSust"] = 29,
  ["lP1TvfEnvEnd"] = 0,
  ["lLfo3Rate"] = 22,
  ["lLfo1Rate"] = 76,
  ["lPartialBalance"] = 50,
  ["lPitchEnvEnd"] = 0,
  ["uLfo1Rate"] = 76,
  ["uPartialBalance"] = 50,
  ["lPitchEnvLvl1"] = 0,
  ["uPitchEnvEnd"] = 0,
  ["uP2TvaEnvT4"] = 0,
  ["TVA"] = 0,
  ["lP2TvaEnvT4"] = 0,
  ["Voice391"] = 57,
  ["uP1PitchFine"] = -5,
  ["lP1PitchFine"] = -5,
  ["lP2TvaKfTime"] = 0,
  ["Voice315"] = 0,
  ["lP1TvfResonance"] = 0,
  ["upperPartial1PCM"] = 0,
  ["Voice56"] = 0,
  ["uP1TvfResonance"] = 0,
  ["TVF123"] = 0,
  ["uP2TvfEnvLvl2"] = 75,
  ["uPitchEnvT2"] = 20,
  ["lP1TvaEnvSust"] = 0,
  ["Voice316"] = 0,
  ["lP2TvaBiasPnt"] = 95,
  ["uP1TvaEnvSust"] = 0,
  ["lP1TvaBiasPnt"] = 95,
  ["Voice248"] = 0,
  ["lP1TvaEnvT1"] = 15,
  ["lP2TvfEnvLvl2"] = 75,
  ["Voice393"] = 0,
  ["lP1TvfBiasLvl"] = 0,
  ["uP2TvfResonance"] = 0,
  ["uP1PitchCoarse"] = 12,
  ["Voice177"] = 0,
  ["uP1TvfEnvLvl3"] = 42,
  ["uP1TvfBiasLvl"] = 0,
  ["uP2PitchCoarse"] = 12,
  ["Voice436"] = 0,
  ["uP1TvaAtRng"] = 0,
  ["lP2TvfEnvLvl1"] = 100,
  ["lP1TvfEnvLvl3"] = 42,
  ["Voice437"] = 0,
  ["Voice57"] = 0,
  ["uP2TvfLfoDepth"] = 0,
  ["uP2TvfEnvLvl1"] = 100,
  ["lP1TvaAtRng"] = 0,
  ["envelope1234567891011121314151617"] = 0,
  ["uP1TvfVelRng"] = 100,
  ["Voice381"] = 0,
  ["chaseMode"] = 2,
  ["lP1TvaVelRng"] = 0,
  ["uP2TvfLfoSel"] = 2,
  ["lP1TvfVelRng"] = 100,
  ["modulator-9"] = 0,
  ["Voice435"] = 0,
  ["holdMode"] = 2,
  ["lP2PitchCoarse"] = 19,
  ["Voice313"] = 0,
  ["uP1TvaVelRng"] = 0,
  ["uP1TvfCutoff"] = 80,
  ["uP1TvfEnvLvl1"] = 100,
  ["lP2TvfEnvT1"] = 0,
  ["lP1TvfEnvT4"] = 48,
  ["lP2TvaVelRng"] = 0,
  ["uP2TvfEnvT1"] = 0,
  ["lP1TvaEnvT3"] = 67,
  ["uP2TvaAtRng"] = 0,
  ["uP1TvfDepth"] = 100,
  ["lP2TvaEnvT5"] = 25,
  ["Voice59"] = 0,
  ["uPitchEnvLvl2"] = 0,
  ["uP2TvaVelKf"] = 0,
  ["UpperPartial1"] = 1,
  ["uP2TvaEnvT3"] = 67,
  ["lP2TvaAtRng"] = 0,
  ["uP1TvfTimeKf"] = 0,
  ["uP1TvaEnvT3"] = 67,
  ["lPitchEnvLvl2"] = 0,
  ["lP1PitchCoarse"] = 19,
  ["uP1TvfLfoSel"] = 2,
  ["lP1TvfEnvSust"] = 29,
  ["atBlendRange"] = -12,
  ["Voice263"] = 67,
  ["uP1TvfEnvSust"] = 29,
  ["Voice326"] = 31,
  ["Load"] = 0,
  ["lP2TvfResonance"] = 0,
  ["lP1TvfEnvT1"] = 0,
  ["uP2TvfDepth"] = 100,
  ["lP1TvfLfoSelect"] = 2,
  ["reverbType"] = 11,
  ["uP1TvaVelKf"] = 0,
  ["uP1TvfEnvT1"] = 0,
  ["envelope1234567891011"] = 0,
  ["Voice433"] = 0,
  ["uP1TvaLvl"] = 85,
  ["lP2LfoMode"] = 3,
  ["envelope12345678910111213141516171819"] = 0,
  ["uP2LfoMode"] = 3,
  ["lP2TvfDepth"] = 75,
  ["Voice389"] = 32,
  ["Voice398"] = 0,
  ["uP2TvfEnvT2"] = 24,
  ["Voice190"] = 0,
  ["Partial2Upper"] = 0,
  ["lPitchEnvT3"] = 20,
  ["lP2TvfEnvT2"] = 24,
  ["uP2BenderMode"] = 1,
  ["uPitchEnvT3"] = 20,
  ["Partial1Lower"] = 0,
  ["LowerPartial2"] = 1,
  ["Voice181"] = 0,
  ["lP1TvfCutoff"] = 80,
  ["Voice427"] = 0,
  ["uP1LfoMode"] = 1,
  ["uP1TvfLfoDepth"] = 0,
  ["Voice130"] = 3,
  ["Voice189"] = 0,
  ["lChorusDepth"] = 60,
  ["uP1TvaEnvLvl3"] = 0,
  ["lP1TvaEnvLvl2"] = 0,
  ["Voice132"] = 38,
  ["upperStructure"] = 0,
  ["chaseTime"] = 50,
  ["uP1TvaEnvLvl2"] = 0,
  ["uP2TvaTimeKf"] = 0,
  ["Voice62"] = 0,
  ["lP1TvfLfoDepth"] = 0,
  ["uP1TvaEnvT2"] = 97,
  ["uP1LfoDepth"] = 0,
  ["uP1BenderMode"] = 1,
  ["Voice396"] = 0,
  ["lP1BenderMode"] = 1,
  ["lP1TvaEnvT2"] = 97,
  ["lP1LfoDepth"] = 0,
  ["Voice127"] = 0,
  ["combinedGroup1"] = 0,
  ["lP1TvaLevel"] = 85,
  ["Patch"] = 0,
  ["Name1"] = 0,
  ["uLowGain"] = 12,
  ["uP1TvfDepthKf"] = 0,
  ["lP2TvfEnvT5"] = 48,
  ["lP2TvfBiasLevel"] = 0,
  ["Voice378"] = 0,
  ["lP2TvfKf"] = 7,
  ["uP2TvaLfoSel"] = 0,
  ["lHighGain"] = 2,
  ["Partial1Upper"] = 0,
  ["Voice375"] = 0,
  ["uP2TvfEnvT5"] = 48,
  ["uHighGain"] = 2,
  ["chaseLevel"] = 50,
  ["envelope123"] = 0,
  ["modulator-1"] = 0,
  ["Voice386"] = 34,
  ["lP1TvaLfoSelect"] = 0,
  ["CommonUpper"] = 0,
  ["lP2TvaLfoSelect"] = 0,
  ["Voice180"] = 0,
  ["uHighFreq"] = 11,
  ["uChorusRate"] = 40,
  ["Voice134"] = 31,
  ["lHighFreq"] = 11,
  ["uP1TvfEnvT5"] = 48,
  ["uLfo3DelayTime"] = 0,
  ["Voice385"] = 46,
  ["lP1TvfEnvT5"] = 48,
  ["Voice368"] = 0,
  ["Voice128"] = 4,
  ["uPitchVelRng"] = 0,
  ["lP1TvfKfTime"] = 0,
  ["lP2TvaEnvLvl2"] = 0,
  ["lLfo3DelayTime"] = 0,
  ["lP1TvaKfVel"] = 0,
  ["uP2TvfEnvT3"] = 40,
  ["lChorusRate"] = 30,
  ["uP2TvaEnvLvl2"] = 0,
  ["lP2TvfEnvT3"] = 40,
  ["lowerPartial1PCM"] = 0,
  ["Voice399"] = 0,
  ["Voice312"] = 0,
  ["portamentoTime"] = 64,
  ["uP2PKeyfollow"] = 11,
  ["Voice383"] = 0,
  ["lP2PEnvMode"] = 0,
  ["uP2TvfTimeKf"] = 0,
  ["LowEQ1"] = 0,
  ["lP2TvfBiasPnt"] = 27,
  ["Voice384"] = 57,
  ["envelope123456789"] = 0,
  ["lP1PulseWidth"] = 0,
  ["lP1PKeyfollow"] = 11,
  ["uP2TvfBiasPnt"] = 27,
  ["lowerPartial2PCM"] = 0,
  ["Voice176"] = 0,
  ["uP1PulseWidth"] = 0,
  ["uP1TvfBiasPnt"] = 27,
  ["Voice188"] = 0,
  ["LowEQ"] = 0,
  ["uP2PulseWidth"] = 0,
  ["Voice380"] = 0,
  ["lPitchEnvSust"] = 0,
  ["uP1TvfEnvT4"] = 48,
  ["uP1PKeyfollow"] = 11,
  ["lP2PKeyfollow"] = 11,
  ["uP2TvfDepthKf"] = 0,
  ["Voice54"] = 0,
  ["lP1TvfEnvLvl1"] = 100,
  ["Voice55"] = 0,
  ["uP1TvaLfoDepth"] = 0,
  ["patchSelect"] = 0,
  ["Voice119"] = 0,
  ["Voice120"] = 0,
  ["uP2TvfEnvLvl3"] = 42,
  ["uP2TvaEnvLvl3"] = 0,
  ["uP1TvfEnvT3"] = 40,
  ["TVA1"] = 0,
  ["Voice71"] = 67,
  ["lP2TvfEnvLvl3"] = 42,
  ["uLfo2DelayTime"] = 0,
  ["Voice136"] = 46,
  ["Voice372"] = 0,
  ["toneSelector"] = 0,
  ["lLfo2DelayTime"] = 0,
  ["lP1TvfKfDepth"] = 0,
  ["uP1TvfEnvT2"] = 24,
  ["lP2TvaEnvLvl3"] = 0,
  ["Voice376"] = 0,
  ["uP1TvaLfoSel"] = 0,
  ["uPitchEnvLvl0"] = 0,
  ["lP1TvfEnvT2"] = 24,
  ["LFO2"] = 0,
  ["lP2TvaLfoDepth"] = 0,
  ["uP2TvaBiasLvl"] = 12,
  ["uP2TvfBiasLvl"] = 0,
  ["Voice392"] = 62,
  ["Voice251"] = 0,
  ["uP1TvfKeyfollow"] = 7,
  ["uP2TvaLfoDepth"] = 0,
  ["lP1TvaEnvT5"] = 25,
  ["uPitchEnvT1"] = 20,
  ["Voice428"] = 3,
  ["HighEQ1"] = 0,
  ["Voice430"] = 0,
  ["uLfo2Sync"] = 0,
  ["Voice400"] = 0,
  ["uP2TvfKeyfollow"] = 7,
  ["lLfo2Sync"] = 0,
  ["uLowFreq"] = 1,
  ["Voice324"] = 38,
  ["lLowFreq"] = 1,
  ["Voice60"] = 0,
  ["lChorusType"] = 0,
  ["HighEQ"] = 0,
  ["lP2TvaEnvEnd"] = 0,
  ["lPitchLFODepth"] = 0,
  ["lP1TvaLfoDepth"] = 0,
  ["uP2TvaEnvEnd"] = 0,
  ["uPitchLFODepth"] = 0,
  ["uChorusType"] = 0,
  ["keyMode"] = 1,
  ["uPitchEnvT4"] = 20,
  ["upperPartial1PCM-1"] = 0,
  ["modulator-12"] = 0,
  ["lPitchVelRng"] = 0,
  ["uP1TvfEnvLvl2"] = 75,
  ["Voice125"] = 0,
  ["UpperPartial2"] = 1,
  ["modulator-8"] = 0,
  ["modulator-7"] = 0,
  ["portamentoMode"] = 2,
  ["modulator-5"] = 0,
  ["LFOUpper"] = 0,
  ["lP2Waveform"] = 1,
  ["lP1TvfEnvLvl2"] = 75,
  ["Voice447"] = 0,
  ["envelope123456789101112131415"] = 0,
  ["LFO21"] = 0,
  ["Voice425"] = 0,
  ["uP2PitchFine"] = 5,
  ["uPitchEnvLvl1"] = 0,
  ["Voice444"] = 0,
  ["lP2TvaLevel"] = 85,
  ["lPitchEnvT4"] = 20,
  ["Voice443"] = 0,
  ["lPitchLever"] = 47,
  ["lP2PitchFine"] = 5,
  ["Voice442"] = 0,
  ["Voice183"] = 0,
  ["Voice182"] = 0,
  ["Voice118"] = 0,
  ["lLowGain"] = 12,
  ["Voice440"] = 0,
  ["uP1VelRng"] = 0,
  ["Voice379"] = 0,
  ["Voice438"] = 0,
  ["Voice135"] = 29,
  ["uP1TvaEnvEnd"] = 0,
  ["lLfo3Waveform"] = 0,
  ["LFO1"] = 0,
  ["Voice434"] = 0,
  ["Voice432"] = 0,
  ["Voice129"] = 63,
  ["Voice388"] = 41,
  ["uP1TvaEnvT5"] = 25,
  ["Voice319"] = 0,
  ["uP1TvfAtRgn"] = 0,
  ["lPitchEnvT1"] = 20,
  ["Voice131"] = 41,
  ["Voice185"] = 0,
  ["WGPITCH1"] = 0,
  ["Voice247"] = 0,
  ["lLfo1DelayTime"] = 0,
  ["Chorus1"] = 0,
  ["lP1VelRng"] = 0,
  ["Voice426"] = 0,
  ["benderRange"] = 2,
  ["Voice424"] = 0,
  ["Voice321"] = 63,
  ["VoiceName123"] = 0,
  ["PITCHENV1"] = 0,
  ["Voice422"] = 0,
  ["Voice421"] = 0,
  ["lP2TvfAtRng"] = 0,
  ["Voice446"] = 0,
  ["Voice250"] = 0,
  ["envelope12345678910111213"] = 0,
  ["modulator-10"] = 0,
  ["lP2TvfLfoSelect"] = 2,
  ["Voice58"] = 0,
  ["uLfo1Sync"] = 0,
  ["uP1TvaEnvLvl1"] = 100,
  ["Voice401"] = 0,
  ["Voice369"] = 0,
  ["Voice186"] = 0,
  ["lP1Waveform"] = 1,
  ["lP2TvaEnvT2"] = 97,
  ["Voice124"] = 0,
  ["TVF12"] = 0,
  ["Voice374"] = 0,
  ["Save"] = 0,
  ["Voice373"] = 0,
  ["uP1TvaEnvT4"] = 0,
  ["Voice371"] = 0,
  ["Voice431"] = 0,
  ["uP2TvaEnvT2"] = 97,
  ["Voice318"] = 0,
  ["Voice317"] = 0,
  ["lP2PulseWidth"] = 0,
  ["lP2TvfKfTime"] = 0,
  ["lP2TvaEnvLvl1"] = 87,
  ["lP2TvaEnvT1"] = 16,
  ["Voice_globalPatchControls"] = 0,
  ["LFOLower"] = 0,
  ["Voice249"] = 0,
  ["uP1AtRng"] = 0,
  ["lP1PEnvMode"] = 0,
  ["Voice254"] = 0,
  ["Voice253"] = 0,
  ["Voice323"] = 41,
  ["uP2TvaEnvT1"] = 15,
  ["uP2TvfEnvEnd"] = 0,
  ["Voice63"] = 0,
  ["LFO31"] = 0,
  ["TVA123"] = 0,
  ["lP2BenderMode"] = 1,
  ["uP2PEnvMode"] = 0,
  ["splitPoint"] = 29,
  ["lP1TvfKf"] = 7,
  ["Voice191"] = 0,
  ["lP1TvfBiasPnt"] = 27,
  ["Voice397"] = 0,
  ["Voice187"] = 0,
  ["uP2TvaEnvLvl1"] = 100,
  ["Voice325"] = 38,
  ["lP1TvaEnvLvl1"] = 100,
  ["TVF1"] = 0,
  ["WGPITCH"] = 0,
  ["TVF"] = 0,
  ["uPitchEnvSust"] = 0,
  ["Voice441"] = 0,
  ["uP1PEnvMode"] = 0,
  ["lP2TvfLfoDepth"] = 0,
  ["uP1TvfEnvEnd"] = 0,
  ["Voice178"] = 0,
  ["uPitchAfterTouch"] = 23,
  ["modulator-6"] = 0,
  ["Voice123"] = 0,
  ["lP1TvfEnvT3"] = 40,
  ["uLfo2Rate"] = 25,
  ["Voice395"] = 0,
  ["uP1TvaBiasLvl"] = 12,
  ["Voice61"] = 0,
  ["Voice382"] = 0,
  ["uP2TvfCutoff"] = 80,
  ["Voice7"] = 49,
  ["Voice377"] = 0,
  ["lPitchEnvLvl0"] = 0,
  ["Voice328"] = 46,
  ["Voice387"] = 0,
  ["uP2TvaBiasPnt"] = 95,
  ["uP2Waveform"] = 1,
  ["Voice390"] = 0,
  ["Voice322"] = 3,
  ["Voice133"] = 38,
  ["lP2VelRng"] = 0,
  ["Voice423"] = 0,
  ["lLfo1Sync"] = 0,
  ["modulator-4"] = 0,
  ["lStructure"] = 0,
  ["uP2VelRng"] = 0,
  ["Partial2Lower"] = 0,
  ["envelope12345"] = 0,
  ["lPitchTimeKeyfollow"] = 0,
  ["VoiceName12"] = 0,
  ["CommonLower"] = 0,
  ["Voice311"] = 0,
  ["uToneKeyShft"] = 0,
  ["lP1LfoMode"] = 1,
  ["reverbBalance"] = 25,
  ["lP2TvaEnvT3"] = 67,
  ["lP2TvfKfDepth"] = 0,
  ["Voice199"] = 49,
  ["WGPITCH12"] = 0,
  ["uP1Waveform"] = 1,
  ["lHighQ"] = 0,
  ["uP2TvaEnvT5"] = 25,
  ["uLever"] = 47,
  ["lP2TvaKfVelocity"] = 0,
  ["uP2TvaVelRng"] = 0,
  ["uHighQ"] = 0,
  ["uP2TvaLvl"] = 85,
  ["Voice122"] = 0,
  ["Voice445"] = 0,
  ["lP2TvfCutoff"] = 80,
  ["lP1TvaEnvLvl3"] = 0,
  ["totalVolume"] = 100,
  ["uPitchTimeKeyfollow"] = 0,
  ["lP1TvfDepth"] = 75,
  ["lP2TvfEnvT4"] = 48,
  ["lToneKeyShft"] = 0,
  ["LowerPartial1"] = 1,
  ["TVA12"] = 0,
  ["lLfo3Sync"] = 1,
  ["lLfo2Rate"] = 25,
  ["uP2TvfEnvT4"] = 48,
}

function setup()
  local log = Logger("GLOBAL")
  log:setLevel(3)
  regGlobal("LOGGER", log)

  midiMessages = {}
  local midiListener = function(midiMessage)
    table.insert(midiMessages, midiMessage)
  end
  regGlobal("panel", MockPanel("Roland-D50.panel", midiListener))
  onPanelBeforeLoad()
end

function teardown()
  delGlobal("midiService")
end

function testOnPatchDroppedToPanel()
  loadPatchFromFile("C:\\ctrlr\\syxfiles\\D50\\5th of 50.syx", panel, modulatorMap, "Name1", "303 in my LFO     ")
end

function testOnBankDroppedToPanel()
  loadBankFromFile(rolandD50Controller, "C:/ctrlr/syxfiles/D50/BobbyBluz_1.syx", panel, _303Map, "Name1", {"5th of 50         ", "303 in my LFO     "})
end

function testLoadAndSendBank()
  compareLoadedBankWithFile(rolandD50Controller, "C:/ctrlr/syxfiles/D50/BobbyBluz_1.syx", panel, NUM_PATCHES_IN_BANK)
end

function testEditAndSendBank()
  compareEditedBankWithFile(rolandD50Controller, "C:/ctrlr/syxfiles/D50/PND50-01.syx", panel,
    {  ["totalVolume"] = 0 }, "C:/ctrlr/syxfiles/D50/PND50-01-2.syx")
end

runTests{useANSI = false}
