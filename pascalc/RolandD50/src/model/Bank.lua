require("AbstractBank")
require("model/Patch")
require("Logger")
require("lutils")

local REVERB_DATA = "0a 02 06 02 00 08 0d 03 0c 02 06 02 06 0d 02 03 0b 02 06 02 02 0f 08 02 00 0b 05 03 01 0f 08 02 04 0a 0a 02 08 06 08 03 03 0a 0a 02 08 07 0b 02 07 07 0b 02 01 0d 0b 02 0a 0f 08 03 0f 0f 0f 03 0a 00 0b 03 0a 00 0d 03 00 06 0d 03 00 06 0d 03 06 0b 09 01 08 07 0c 00 08 01 07 00 03 0a 02 01 09 03 00 00 07 09 04 00 09 09 09 00 08 05 0f 00 06 09 04 00 08 09 09 00 0f 0e 05 01 0e 07 0d 01 07 05 0f 00 08 06 02 00 0e 0e 05 01 0d 07 0d 01 09 02 06 02 04 0d 01 02 08 0e 01 03 00 00 02 02 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 08 03 0a 01 08 03 0a 01 00 00 02 02 08 0c 05 01 00 03 0f 01 01 05 0f 01 08 0c 05 01 08 03 0a 01 0c 05 00 01 08 0c 05 01 08 03 0a 01 08 0c 05 01 00 00 00 00 00 01 0f 01 0c 0f 00 01 09 00 01 01 04 0c 00 01 0e 0c 00 01 0d 0e 07 01 08 0f 07 01 0c 0f 07 01 03 0f 07 01 09 09 01 01 00 00 02 02 0b 0c 07 01 05 03 00 01 0d 03 00 01 03 0c 07 01 07 06 08 01 0c 0f 07 01 06 07 08 01 0b 0b 07 01 05 04 00 01 08 0f 07 01 03 0f 07 01 01 0b 07 01 0f 04 00 01 07 08 08 01 0a 09 08 01 0a 05 00 01 06 0a 07 01 0d 0e 07 01 07 0e 07 01 0f 0a 08 01 00 00 02 02 09 09 07 01 07 06 00 01 08 0c 08 01 07 0e 07 01 0a 03 0f 01 0b 07 0a 01 00 06 0f 03 0d 07 0a 01 06 00 0e 03 0c 07 0a 01 0f 08 0f 01 04 07 0e 03 0e 08 0f 01 01 0b 02 02 0c 0d 0e 03 00 0b 02 02 05 0d 03 02 04 0d 03 02 02 02 04 02 02 0f 0e 03 0f 0f 0f 03 01 04 0f 03 0e 08 0f 03 0b 09 0f 03 0b 09 0f 03 0d 0d 01 01 03 0b 08 00 0a 0f 04 00 08 0f 0c 00 09 03 00 00 0f 03 03 00 06 0b 06 00 00 0b 0a 00 0e 03 03 00 05 0b 06 00 00 04 0f 00 0b 07 04 01 0f 0a 0a 00 0c 0b 01 00 0f 03 0f 00 0a 07 04 01 0a 07 0a 01 0b 07 07 01 02 0e 0d 03 00 00 02 02 00 00 0c 01 00 00 00 00 00 00 02 02 00 00 00 00 04 08 0a 01 04 08 0a 01 00 00 02 02 0c 07 05 01 03 0e 0e 01 0a 01 0f 01 0c 07 05 01 04 08 0a 01 04 07 00 01 0c 07 05 01 04 08 0a 01 0c 07 05 01 00 00 00 00 0b 0d 0e 01 07 02 01 01 0a 02 01 01 04 0d 00 01 06 0d 00 01 00 0f 07 01 09 0f 07 01 0d 0f 07 01 05 0f 07 01 05 07 01 01 00 00 02 02 05 02 07 01 0b 0d 00 01 07 0f 00 01 09 00 07 01 06 05 08 01 0d 0f 07 01 02 06 08 01 09 0e 06 01 07 01 01 01 09 0f 07 01 05 0f 07 01 06 0c 06 01 0a 03 01 01 01 07 08 01 01 08 08 01 00 06 01 01 00 0a 06 01 00 0f 07 01 0b 0e 07 01 03 09 08 01 00 00 02 02 05 07 06 01 0b 08 01 01 07 0a 08 01 0b 0e 07 01 05 0e 0e 01 09 0d 00 00 0e 0f 0f 03 0b 0d 00 00 0f 0a 0e 03 0a 0d 00 00 09 0f 00 00 08 0f 0e 03 08 0f 00 00 0b 00 01 00 0d 03 0f 03 0a 00 01 00 07 01 01 00 06 01 01 00 0c 01 01 00 0c 04 0f 03 0f 0f 0f 03 01 08 0f 03 04 0b 0f 03 0c 0b 0f 03 0c 0b 0f 03 09 0a 00 00 01 07 00 00 09 05 00 00 0c 08 00 00 09 03 00 00 0e 04 00 00 05 06 00 00 0e 07 00 00 0d 04 00 00 04 06 00 00 0a 09 00 00 08 0b 00 00 0d 07 00 00 03 04 00 00 09 09 00 00 07 0b 00 00 08 0d 00 00 08 0c 00 00 07 09 0e 03 00 00 02 02 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 04 08 0b 01 04 08 0b 01 00 00 02 02 0c 07 04 01 0d 00 0f 01 08 03 0f 01 0c 07 04 01 04 08 0b 01 07 06 00 01 0c 07 04 01 04 08 0b 01 0c 07 04 01 00 00 00 00 07 0f 0e 01 00 01 01 01 08 01 01 01 0c 0c 00 01 02 0d 00 01 0f 0f 07 01 0f 0f 07 01 00 00 02 02 0f 0f 07 01 08 08 00 01 00 00 02 02 0f 0f 07 01 0b 04 02 00 06 08 02 00 0f 0f 07 01 0b 00 08 01 00 00 02 02 0c 00 08 01 0f 0f 07 01 01 0c 02 00 0f 0f 07 01 0f 0f 07 01 0f 0f 07 01 09 01 03 00 0e 00 08 01 0f 00 08 01 03 05 03 00 0f 0f 07 01 0f 0f 07 01 0e 0f 07 01 00 01 08 01 00 00 02 02 0f 0f 07 01 0b 0a 03 00 02 01 08 01 0e 0f 07 01 04 01 0f 01 00 08 00 00 08 07 02 02 02 08 00 00 0e 0f 0f 03 01 08 00 00 04 08 00 00 0e 0f 0f 03 03 08 00 00 06 08 00 00 0e 0f 0f 03 05 08 00 00 08 08 00 00 07 08 00 00 0f 0e 01 00 0e 0f 0f 03 0f 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 08 07 02 02 08 0f 01 00 04 0f 01 00 02 0f 01 00 06 0f 01 00 00 0f 01 00 02 0f 01 00 04 0f 01 00 06 0f 01 00 01 0f 01 00 03 0f 01 00 08 0f 01 00 0a 0f 01 00 05 0f 01 00 00 0f 01 00 07 0f 01 00 09 0f 01 00 0b 0f 01 00 0a 0f 01 00 0e 0f 0f 03 00 00 00 00 00 00 00 00 00 00 02 02 06 0f 07 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 08 00 00 0c 04 0f 03 02 08 00 00 0e 0f 0f 03 01 08 00 00 04 08 00 00 0e 0f 0f 03 03 08 00 00 06 08 00 00 0e 0f 0f 03 05 08 00 00 08 08 00 00 07 08 00 00 07 0b 0a 02 0e 0f 0f 03 0f 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 0c 04 0f 03 00 0c 0a 02 0c 0b 0a 02 0a 0b 0a 02 0e 0b 0a 02 08 0b 0a 02 0a 0b 0a 02 0c 0b 0a 02 0e 0b 0a 02 09 0b 0a 02 0b 0b 0a 02 00 0c 0a 02 02 0c 0a 02 0d 0b 0a 02 08 0b 0a 02 0f 0b 0a 02 01 0c 0a 02 03 0c 0a 02 02 0c 0a 02 0e 0f 0f 03 00 00 00 00 00 00 00 00 00 00 02 02 0f 08 02 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 06 0f 07 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 08 00 00 00 05 0c 02 02 08 00 00 0e 0f 0f 03 01 08 00 00 04 08 00 00 0e 0f 0f 03 03 08 00 00 06 08 00 00 0e 0f 0f 03 05 08 00 00 08 08 00 00 07 08 00 00 08 03 04 01 0e 0f 0f 03 0f 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 00 05 0c 02 01 04 04 01 0d 03 04 01 0b 03 04 01 0f 03 04 01 09 03 04 01 0b 03 04 01 0d 03 04 01 0f 03 04 01 0a 03 04 01 0c 03 04 01 01 04 04 01 03 04 04 01 0e 03 04 01 09 03 04 01 00 04 04 01 02 04 04 01 04 04 04 01 03 04 04 01 0e 0f 0f 03 00 00 00 00 00 00 00 00 00 00 02 02 01 0e 02 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 0e 02 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 08 00 00 0c 05 00 02 02 08 00 00 0e 0f 0f 03 01 08 00 00 04 08 00 00 0e 0f 0f 03 03 08 00 00 06 08 00 00 0e 0f 0f 03 05 08 00 00 08 08 00 00 07 08 00 00 0b 02 00 02 0e 0f 0f 03 0f 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 0c 05 00 02 04 03 00 02 00 03 00 02 0e 02 00 02 02 03 00 02 0c 02 00 02 0e 02 00 02 00 03 00 02 02 03 00 02 0d 02 00 02 0f 02 00 02 04 03 00 02 06 03 00 02 01 03 00 02 0c 02 00 02 03 03 00 02 05 03 00 02 07 03 00 02 06 03 00 02 0e 0f 0f 03 00 00 00 00 00 00 00 00 00 00 02 02 05 08 03 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 05 08 03 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 08 00 00 08 0d 0e 02 02 08 00 00 0e 0f 0f 03 01 08 00 00 04 08 00 00 0e 0f 0f 03 03 08 00 00 06 08 00 00 0e 0f 0f 03 05 08 00 00 08 08 00 00 07 08 00 00 07 0d 02 02 0e 0f 0f 03 0f 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 0e 0f 0f 03 08 0d 0e 02 00 0e 02 02 0c 0d 02 02 0a 0d 02 02 0e 0d 02 02 08 0d 02 02 0a 0d 02 02 0c 0d 02 02 0e 0d 02 02 09 0d 02 02 0b 0d 02 02 00 0e 02 02 02 0e 02 02 0d 0d 02 02 08 0d 02 02 0f 0d 02 02 01 0e 02 02 03 0e 02 02 02 0e 02 02 0e 0f 0f 03 00 00 00 00 00 00 00 00 00 00 02 02 03 0c 03 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 03 07 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 04 04 00 00 0e 0f 0f 03 07 0a 00 00 02 09 01 03 06 0a 00 00 0c 09 02 00 02 09 01 03 0b 09 02 00 0a 0e 03 00 0c 07 05 03 09 0e 03 00 09 0c 04 00 08 0c 04 00 0d 05 05 00 0c 07 05 03 0f 0f 0f 03 04 02 08 03 04 02 08 03 08 05 0b 03 08 05 0b 03 00 0a 02 02 07 0a 08 02 0b 07 0e 02 07 0a 08 02 06 0d 0b 02 06 0d 0b 02 09 03 05 02 09 03 05 02 0d 0f 0f 03 02 04 00 00 0f 07 0f 01 0f 07 0f 01 02 04 00 00 0b 07 0e 02 02 04 00 00 02 04 00 00 02 04 00 00 00 0a 02 02 00 00 00 00 00 00 02 02 00 00 0b 01 00 00 00 00 00 00 02 02 00 00 05 01 00 00 0b 01 00 00 0b 01 00 00 02 02 00 00 05 01 01 0c 00 01 0c 09 08 01 00 00 05 01 00 00 0b 01 05 08 07 01 00 00 05 01 00 00 0b 01 00 00 05 01 00 00 00 00 04 0c 00 01 0b 0e 01 01 0a 04 07 01 0f 08 05 01 0f 08 05 01 01 0b 00 01 04 0c 01 01 04 03 09 01 0d 0d 06 01 00 00 02 02 0d 02 07 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0a 0b 00 01 00 00 00 00 00 00 00 00 00 00 00 00 08 0c 06 01 02 06 0e 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 0c 04 01 02 0c 04 01 00 00 00 00 0d 08 0d 01 00 00 00 00 00 00 00 00 00 00 00 00 00 0d 06 01 00 00 00 00 04 04 00 00 0e 0f 0f 03 0d 0d 00 00 0d 09 00 03 0c 0d 00 00 0f 0d 03 00 0d 09 00 03 0e 0d 03 00 01 0e 05 00 0f 0f 04 03 00 0e 05 00 08 03 07 00 07 03 07 00 0c 01 08 00 0f 0f 04 03 0f 0f 0f 03 09 0f 07 03 09 0f 07 03 00 09 0b 03 00 09 0b 03 00 0e 0f 01 01 0a 06 02 08 02 0d 02 01 0a 06 02 02 03 0a 02 02 03 0a 02 08 0c 02 02 08 0c 02 02 0d 0f 0f 03 02 04 00 00 0f 05 0c 01 0f 05 0c 01 02 04 00 00 08 02 0d 02 02 04 00 00 02 04 00 00 02 04 00 00 00 0e 0f 01 00 00 00 00 00 00 02 02 00 00 0b 01 00 00 00 00 00 00 02 02 00 00 05 01 00 00 0b 01 00 00 0b 01 00 00 02 02 00 00 05 01 0e 01 00 01 0b 0d 0e 01 00 00 05 01 00 00 0b 01 0e 0d 00 01 00 00 05 01 00 00 0b 01 00 00 05 01 00 00 00 00 07 01 00 01 0a 02 00 01 01 0a 00 01 0b 05 00 01 0b 05 00 01 07 07 00 01 09 0a 00 01 07 09 0e 01 00 09 02 01 00 00 02 02 00 00 02 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 03 00 01 00 00 00 00 00 00 00 00 00 00 00 00 06 06 03 01 01 03 0f 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0a 04 04 01 0a 04 04 01 00 00 00 00 0e 07 0f 01 00 00 00 00 00 00 00 00 00 00 00 00 05 09 04 01 00 00 00 00 04 04 00 00 0e 0f 0f 03 0d 0d 00 00 09 05 0b 02 0c 0d 00 00 0f 0d 03 00 09 05 0b 02 0e 0d 03 00 01 0e 05 00 0b 04 01 03 00 0e 05 00 08 03 07 00 07 03 07 00 0c 01 08 00 0b 04 01 03 0f 0f 0f 03 05 05 05 03 05 05 05 03 04 03 0a 03 04 03 0a 03 00 0a 04 01 0b 0c 0d 01 06 0a 06 02 0b 0c 0d 01 02 0a 02 02 02 0a 02 02 03 09 08 01 03 09 08 01 0d 0f 0f 03 02 04 00 00 0f 0d 0f 00 0f 0d 0f 00 02 04 00 00 06 0a 06 02 02 04 00 00 02 04 00 00 02 04 00 00 00 0a 04 01 00 00 00 00 00 00 02 02 00 00 0b 01 00 00 00 00 00 00 02 02 00 00 05 01 00 00 0b 01 00 00 0b 01 00 00 02 02 00 00 05 01 00 03 00 01 0e 02 0e 01 00 00 05 01 00 00 0b 01 0a 07 01 01 00 00 05 01 00 00 0b 01 00 00 05 01 00 00 00 00 07 02 00 01 0d 04 00 01 04 02 01 01 01 0b 00 01 01 0b 00 01 08 08 00 01 0c 0d 00 01 06 0e 0d 01 08 05 03 01 00 00 02 02 09 0c 02 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 08 04 00 01 00 00 00 00 00 00 00 00 00 00 00 00 05 02 04 01 03 00 0f 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 06 09 04 01 06 09 04 01 00 00 00 00 0e 03 0f 01 00 00 00 00 00 00 00 00 00 00 00 00 0b 03 05 01 00 00 00 00 0d 02 0c 01 00 00 0c 02 0f 02 0c 01 0c 0b 0a 03 0e 02 0c 01 05 0f 0e 01 00 0e 0b 03 04 0f 0e 01 07 0a 00 02 06 0f 0c 03 06 0a 00 02 0b 07 01 02 0a 07 01 02 04 0d 01 02 00 03 0d 03 0f 0f 0f 03 04 00 0e 03 01 0d 0e 03 03 0f 0e 03 03 0f 0e 03 09 0b 03 01 00 01 0a 00 0e 0d 05 00 0b 0a 0e 00 09 03 00 00 0e 0d 03 00 0e 0d 07 00 02 04 0c 00 0d 0d 03 00 0d 0d 07 00 04 01 01 01 0e 05 06 01 01 04 0c 00 0b 00 02 00 03 01 01 01 0d 05 06 01 0c 02 0c 01 05 04 09 01 0d 05 0a 03 00 00 02 02 0a 09 0d 01 00 00 00 00 00 00 02 02 00 00 00 00 09 00 0d 01 09 00 0d 01 00 00 02 02 07 0f 02 01 02 0e 0f 01 0f 0d 0f 01 07 0f 02 01 09 00 0d 01 06 01 00 01 07 0f 02 01 09 00 0d 01 07 0f 02 01 00 00 00 00 08 0b 0f 01 01 06 00 01 01 08 00 01 09 07 00 01 02 0a 00 01 05 0a 07 01 04 0d 07 01 0a 0e 07 01 0d 0b 07 01 03 05 03 01 00 00 02 02 0b 01 07 01 05 0e 00 01 09 0f 00 01 07 00 07 01 00 0d 0b 01 0a 0e 07 01 02 01 0c 01 02 0f 06 01 0e 00 01 01 04 0d 07 01 0d 0b 07 01 0b 0d 06 01 05 02 01 01 05 05 0c 01 0a 09 0c 01 0d 03 01 01 03 0c 06 01 05 0a 07 01 0c 08 07 01 00 0e 0c 01 00 00 02 02 09 0a 06 01 07 05 01 01 06 02 0d 01 0c 08 07 01 09 0e 0f 01 07 09 00 01 00 00 0d 02 09 09 00 01 0d 00 0c 03 08 09 00 01 03 0d 01 01 08 0e 0c 03 02 0d 01 01 03 0b 02 01 08 0b 0d 03 02 0b 02 01 03 03 03 01 02 03 03 01 08 06 03 01 04 0e 0d 03 0f 0f 0f 03 03 08 0e 03 0c 01 0f 03 06 03 0f 03 06 03 0f 03 03 0b 0b 00 0e 00 06 00 04 09 03 00 01 0c 08 00 09 03 00 00 05 06 02 00 04 0c 04 00 09 05 07 00 04 06 02 00 03 0c 04 00 0a 02 0a 00 0d 03 0d 00 08 05 07 00 0f 04 01 00 09 02 0a 00 0c 03 0d 00 06 09 00 01 09 0e 0e 00 05 0c 0b 03 00 00 02 02 0a 00 0f 01 00 00 00 00 00 00 02 02 00 00 00 00 06 05 0b 01 06 05 0b 01 00 00 02 02 0a 0a 04 01 0e 06 0f 01 00 08 0f 01 0a 0a 04 01 06 05 0b 01 06 04 00 01 0a 0a 04 01 06 05 0b 01 0a 0a 04 01 00 00 00 00 00 04 0f 01 03 0d 00 01 07 0e 00 01 04 0b 00 01 05 0c 00 01 01 0e 07 01 01 0f 07 01 09 0f 07 01 09 0e 07 01 00 08 02 01 00 00 02 02 04 0c 06 01 0c 03 01 01 04 05 01 01 0c 0a 06 01 08 03 09 01 09 0f 07 01 02 05 09 01 02 09 06 01 0e 06 01 01 01 0f 07 01 09 0e 07 01 07 07 06 01 09 08 01 01 0d 06 09 01 0b 08 09 01 06 0a 01 01 0a 05 06 01 01 0e 07 01 07 0d 07 01 0b 0a 09 01 00 00 02 02 0c 03 06 01 04 0c 01 01 0d 0c 09 01 07 0d 07 01 0b 07 0f 01 00 04 08 02 00 0c 0f 02 02 04 08 02 0b 06 09 03 01 04 08 02 08 00 0b 02 08 0d 0a 03 07 00 0b 02 0a 0b 0c 02 04 03 0c 03 09 0b 0c 02 0e 08 0d 02 0d 08 0d 02 07 0e 0d 02 0d 07 0c 03 0f 0f 0f 03 05 08 0d 03 05 08 0e 03 00 0b 0e 03 00 0b 0e 03 05 02 0c 01 0f 04 0e 00 0e 04 08 00 07 0e 04 01 09 03 00 00 01 07 05 00 0b 02 0b 00 04 07 01 01 00 07 05 00 0a 02 0b 00 0b 05 08 01 0f 0e 0f 01 03 07 01 01 05 0d 02 00 0a 05 08 01 0e 0e 0f 01 0f 03 08 02 07 01 04 02 04 0f 08 03 00 00 02 02 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 08 01 0b 01 08 01 0b 01 00 00 02 02 08 0e 04 01 03 06 0f 01 07 07 0f 01 08 0e 04 01 08 01 0b 01 0a 04 00 01 08 0e 04 01 08 01 0b 01 08 0e 04 01 00 00 00 00 06 03 0f 01 0b 0d 00 01 0e 0e 00 01 07 0b 00 01 07 0c 00 01 05 0d 07 01 0c 0e 07 01 07 0f 07 01 01 0e 07 01 06 0a 02 01 00 00 02 02 03 09 07 01 0d 06 00 01 07 07 00 01 09 08 07 01 0a 08 09 01 07 0f 07 01 0d 0a 09 01 0e 07 07 01 02 08 00 01 0c 0e 07 01 01 0e 07 01 02 07 07 01 0e 08 00 01 01 0d 09 01 09 0f 09 01 0b 09 00 01 05 06 07 01 05 0d 07 01 09 0c 07 01 03 02 0a 01 00 00 02 02 07 05 07 01 09 0a 00 01 00 05 0a 01 09 0c 07 01 0f 06 0f 01 0e 02 0f 02 00 02 0e 03 00 03 0f 02 0b 06 09 03 0f 02 0f 02 03 08 02 03 08 0d 0a 03 02 08 02 03 06 07 04 03 04 03 0c 03 05 07 04 03 0f 0f 04 03 0e 0f 04 03 05 02 05 03 0d 07 0c 03 0f 0f 0f 03 05 08 0d 03 05 08 0e 03 00 0b 0e 03 00 0b 0e 03 0d 06 03 02 05 0c 03 01 03 0f 0b 00 09 09 0b 01 09 03 00 00 0a 00 08 00 0c 0d 0f 00 0f 0a 07 01 09 00 08 00 0b 0d 0f 00 03 08 0f 01 08 05 07 02 0e 0a 07 01 01 02 04 00 02 08 0f 01 07 05 07 02 0d 02 0f 02 03 04 0b 02 04 0f 08 03 00 00 02 02 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 04 00 0a 01 04 00 0a 01 00 00 02 02 0c 0f 05 01 0f 0f 0e 01 0e 02 0f 01 0c 0f 05 01 04 00 0a 01 0b 06 00 01 0c 0f 05 01 04 00 0a 01 0c 0f 05 01 00 00 00 00 0e 0e 0e 01 08 01 01 01 0e 01 01 01 0f 0c 00 01 03 0d 00 01 00 00 02 02 00 00 02 02 00 00 02 02 00 00 02 02 03 00 02 01 00 00 02 02 07 0f 07 01 09 00 00 01 09 00 00 01 07 0f 07 01 04 0a 08 01 00 00 02 02 04 0a 08 01 07 0f 07 01 09 00 00 01 00 00 02 02 00 00 02 02 07 0f 07 01 09 00 00 01 04 0a 08 01 04 0a 08 01 09 00 00 01 07 0f 07 01 00 00 02 02 00 00 02 02 04 0a 08 01 00 00 02 02 07 0f 07 01 09 00 00 01 04 0a 08 01 00 00 02 02 04 00 0f 01 00 04 08 02 00 06 0f 03 02 04 08 02 0d 0d 00 03 01 04 08 02 0a 0f 0a 02 04 02 04 03 09 0f 0a 02 02 0d 0c 02 04 04 07 03 01 0d 0c 02 0a 00 0e 02 09 00 0e 02 09 06 0e 02 0c 0e 07 03 0f 0f 0f 03 0c 04 0a 03 09 09 0c 03 0c 0f 0c 03 0c 0f 0c 03 05 02 0c 01 0f 04 0e 00 0e 04 08 00 07 0e 04 01 09 03 00 00 01 07 05 00 0b 02 0b 00 04 07 01 01 00 07 05 00 0a 02 0b 00 0b 05 08 01 0f 0e 0f 01 03 07 01 01 05 0d 02 00 0a 05 08 01 0e 0e 0f 01 0f 03 08 02 07 01 04 02 0b 0c 0f 02 00 00 02 02 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 0c 0d 09 01 0c 0d 09 01 00 00 02 02 04 02 06 01 09 0d 0e 01 03 01 0f 01 04 02 06 01 0c 0d 09 01 07 07 00 01 04 02 06 01 0c 0d 09 01 04 02 06 01 00 00 00 00 05 0d 0e 01 0c 02 01 01 0e 02 01 01 06 0d 00 01 07 0d 00 01 0f 0f 07 01 0f 0f 07 01 00 00 02 02 0f 0f 07 01 0e 07 00 01 00 00 02 02 0c 0a 07 01 04 05 00 01 0c 05 00 01 04 0a 07 01 0a 00 08 01 00 00 02 02 0b 00 08 01 0c 09 07 01 04 06 00 01 0f 0f 07 01 0f 0f 07 01 03 09 07 01 0d 06 00 01 0c 00 08 01 0d 00 08 01 07 07 00 01 09 08 07 01 0f 0f 07 01 0f 0f 07 01 0e 00 08 01 00 00 02 02 0e 07 07 01 02 08 00 01 00 01 08 01 0f 0f 07 01 0a 0d 0e 01"

Voice_singleSize = 448

local BANK_BUFFER_SIZE = 28672

local log = Logger("Bank")

Bank = {}
Bank.__index = Bank

setmetatable(Bank, {
  __index = AbstractBank, -- this is what makes the inheritance work
  __call = function (cls, ...)
    local self = setmetatable({}, cls)
    self:_init(...)
    return self
  end,
})

function Bank:_init(bankData)
  AbstractBank._init(self)

  local defaultReverbData = MemoryBlock(REVERB_DATA)

  self.patches = {}
  if bankData == nil then
    self.data = MemoryBlock(Voice_singleSize * 64 + defaultReverbData:getSize(), true)
    self.data:copyFrom(defaultReverbData, Voice_singleSize * 64, defaultReverbData:getSize())

    for i = 0, 63 do
      local p = Patch(self.data, i * Voice_singleSize)
      p:setPatchName("NEW PATCH")
      table.insert(self.patches, p)
    end
  else
    self.data = midiService:trimSyxData(bankData)
    assert(self.data:getSize() == Voice_singleSize * 64 + defaultReverbData:getSize(), string.format("Data does not contain a Roland D50 bank"))

    for i = 0, 63 do
      table.insert(self.patches, Patch(self.data, i * Voice_singleSize))
    end
  end
end

function Bank:getSelectedPatch()
  return self.patches[self.selectedPatchIndex + 1]
end

function Bank:toStandaloneData()
  local splitData = midiService:splitIntoSysexMessages(self.data)

  local splitDataSize = 0
  for i, data in ipairs(splitData) do
    splitDataSize = splitDataSize + data:getSize()
  end

  local dataToWrite = MemoryBlock(splitDataSize, true)
  local destinationOffset = 0
  for i, data in ipairs(splitData) do
    local dataSize = data:getSize()
    dataToWrite:copyFrom(data, destinationOffset, dataSize)
    destinationOffset = destinationOffset + dataSize
  end
  return dataToWrite
end

function Bank:toSyxMessages()
  local splitData = midiService:splitIntoSysexMessages(self.data)

  local msgs = {}
  for data in ipairs(splitData) do
    table.insert(msgs, D50SyxMsg(data))
  end
  return msgs
end
